var wysihtml5={version:"0.3.0_rc2",commands:{},dom:{},quirks:{},toolbar:{},lang:{},selection:{},views:{},INVISIBLE_SPACE:"ï»¿",EMPTY_FUNCTION:function(){},ELEMENT_NODE:1,TEXT_NODE:3,BACKSPACE_KEY:8,ENTER_KEY:13,ESCAPE_KEY:27,SPACE_KEY:32,DELETE_KEY:46};window.rangy=function(){function isHostMethod(o,p){var t=typeof o[p];return t==FUNCTION||t==OBJECT&&!!o[p]||t=="unknown"}function isHostObject(o,p){return typeof o[p]==OBJECT&&!!o[p]}function isHostProperty(o,p){return typeof o[p]!=UNDEFINED}function createMultiplePropertyTest(testFunc){return function(o,props){var i=props.length;while(i--)if(!testFunc(o,props[i]))return!1;return!0}}function isTextRange(range){return range&&areHostMethods(range,textRangeMethods)&&areHostProperties(range,textRangeProperties)}function fail(reason){window.alert("Rangy not supported in your browser. Reason: "+reason),api.initialized=!0,api.supported=!1}function warn(msg){var warningMessage="Rangy warning: "+msg;api.config.alertOnWarn?window.alert(warningMessage):typeof window.console!=UNDEFINED&&typeof window.console.log!=UNDEFINED&&window.console.log(warningMessage)}function init(){if(api.initialized)return;var testRange,implementsDomRange=!1,implementsTextRange=!1;isHostMethod(document,"createRange")&&(testRange=document.createRange(),areHostMethods(testRange,domRangeMethods)&&areHostProperties(testRange,domRangeProperties)&&(implementsDomRange=!0),testRange.detach());var body=isHostObject(document,"body")?document.body:document.getElementsByTagName("body")[0];body&&isHostMethod(body,"createTextRange")&&(testRange=body.createTextRange(),isTextRange(testRange)&&(implementsTextRange=!0)),!implementsDomRange&&!implementsTextRange&&fail("Neither Range nor TextRange are implemented"),api.initialized=!0,api.features={implementsDomRange:implementsDomRange,implementsTextRange:implementsTextRange};var allListeners=moduleInitializers.concat(initListeners);for(var i=0,len=allListeners.length;i<len;++i)try{allListeners[i](api)}catch(ex){isHostObject(window,"console")&&isHostMethod(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",ex)}}function createMissingNativeApi(win){win=win||window,init();for(var i=0,len=createMissingNativeApiListeners.length;i<len;++i)createMissingNativeApiListeners[i](win)}function Module(name){this.name=name,this.initialized=!1,this.supported=!1}var OBJECT="object",FUNCTION="function",UNDEFINED="undefined",domRangeProperties=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],domRangeMethods=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],textRangeProperties=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],textRangeMethods=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"],areHostMethods=createMultiplePropertyTest(isHostMethod),areHostObjects=createMultiplePropertyTest(isHostObject),areHostProperties=createMultiplePropertyTest(isHostProperty),api={version:"1.2.2",initialized:!1,supported:!0,util:{isHostMethod:isHostMethod,isHostObject:isHostObject,isHostProperty:isHostProperty,areHostMethods:areHostMethods,areHostObjects:areHostObjects,areHostProperties:areHostProperties,isTextRange:isTextRange},features:{},modules:{},config:{alertOnWarn:!1,preferTextRange:!1}};api.fail=fail,api.warn=warn,{}.hasOwnProperty?api.util.extend=function(o,props){for(var i in props)props.hasOwnProperty(i)&&(o[i]=props[i])}:fail("hasOwnProperty not supported");var initListeners=[],moduleInitializers=[];api.init=init,api.addInitListener=function(listener){api.initialized?listener(api):initListeners.push(listener)};var createMissingNativeApiListeners=[];api.addCreateMissingNativeApiListener=function(listener){createMissingNativeApiListeners.push(listener)},api.createMissingNativeApi=createMissingNativeApi,Module.prototype.fail=function(reason){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+reason)},Module.prototype.warn=function(msg){api.warn("Module "+this.name+": "+msg)},Module.prototype.createError=function(msg){return new Error("Error in Rangy "+this.name+" module: "+msg)},api.createModule=function(name,initFunc){var module=new Module(name);api.modules[name]=module,moduleInitializers.push(function(api){initFunc(api,module),module.initialized=!0,module.supported=!0})},api.requireModules=function(modules){for(var i=0,len=modules.length,module,moduleName;i<len;++i){moduleName=modules[i],module=api.modules[moduleName];if(!module||!(module instanceof Module))throw new Error("Module '"+moduleName+"' not found");if(!module.supported)throw new Error("Module '"+moduleName+"' not supported")}};var docReady=!1,loadHandler=function(e){docReady||(docReady=!0,api.initialized||init())};if(typeof window==UNDEFINED){fail("No window found");return}if(typeof document==UNDEFINED){fail("No document found");return}return isHostMethod(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",loadHandler,!1),isHostMethod(window,"addEventListener")?window.addEventListener("load",loadHandler,!1):isHostMethod(window,"attachEvent")?window.attachEvent("onload",loadHandler):fail("Window does not have required addEventListener or attachEvent method"),api}(),rangy.createModule("DomUtil",function(api,module){function isHtmlNamespace(node){var ns;return typeof node.namespaceURI==UNDEF||(ns=node.namespaceURI)===null||ns=="http://www.w3.org/1999/xhtml"}function parentElement(node){var parent=node.parentNode;return parent.nodeType==1?parent:null}function getNodeIndex(node){var i=0;while(node=node.previousSibling)i++;return i}function getNodeLength(node){var childNodes;return isCharacterDataNode(node)?node.length:(childNodes=node.childNodes)?childNodes.length:0}function getCommonAncestor(node1,node2){var ancestors=[],n;for(n=node1;n;n=n.parentNode)ancestors.push(n);for(n=node2;n;n=n.parentNode)if(arrayContains(ancestors,n))return n;return null}function isAncestorOf(ancestor,descendant,selfIsAncestor){var n=selfIsAncestor?descendant:descendant.parentNode;while(n){if(n===ancestor)return!0;n=n.parentNode}return!1}function getClosestAncestorIn(node,ancestor,selfIsAncestor){var p,n=selfIsAncestor?node:node.parentNode;while(n){p=n.parentNode;if(p===ancestor)return n;n=p}return null}function isCharacterDataNode(node){var t=node.nodeType;return t==3||t==4||t==8}function insertAfter(node,precedingNode){var nextNode=precedingNode.nextSibling,parent=precedingNode.parentNode;return nextNode?parent.insertBefore(node,nextNode):parent.appendChild(node),node}function splitDataNode(node,index){var newNode=node.cloneNode(!1);return newNode.deleteData(0,index),node.deleteData(index,node.length-index),insertAfter(newNode,node),newNode}function getDocument(node){if(node.nodeType==9)return node;if(typeof node.ownerDocument!=UNDEF)return node.ownerDocument;if(typeof node.document!=UNDEF)return node.document;if(node.parentNode)return getDocument(node.parentNode);throw new Error("getDocument: no document found for node")}function getWindow(node){var doc=getDocument(node);if(typeof doc.defaultView!=UNDEF)return doc.defaultView;if(typeof doc.parentWindow!=UNDEF)return doc.parentWindow;throw new Error("Cannot get a window object for node")}function getIframeDocument(iframeEl){if(typeof iframeEl.contentDocument!=UNDEF)return iframeEl.contentDocument;if(typeof iframeEl.contentWindow!=UNDEF)return iframeEl.contentWindow.document;throw new Error("getIframeWindow: No Document object found for iframe element")}function getIframeWindow(iframeEl){if(typeof iframeEl.contentWindow!=UNDEF)return iframeEl.contentWindow;if(typeof iframeEl.contentDocument!=UNDEF)return iframeEl.contentDocument.defaultView;throw new Error("getIframeWindow: No Window object found for iframe element")}function getBody(doc){return util.isHostObject(doc,"body")?doc.body:doc.getElementsByTagName("body")[0]}function getRootContainer(node){var parent;while(parent=node.parentNode)node=parent;return node}function comparePoints(nodeA,offsetA,nodeB,offsetB){var nodeC,root,childA,childB,n;if(nodeA==nodeB)return offsetA===offsetB?0:offsetA<offsetB?-1:1;if(nodeC=getClosestAncestorIn(nodeB,nodeA,!0))return offsetA<=getNodeIndex(nodeC)?-1:1;if(nodeC=getClosestAncestorIn(nodeA,nodeB,!0))return getNodeIndex(nodeC)<offsetB?-1:1;root=getCommonAncestor(nodeA,nodeB),childA=nodeA===root?root:getClosestAncestorIn(nodeA,root,!0),childB=nodeB===root?root:getClosestAncestorIn(nodeB,root,!0);if(childA===childB)throw new Error("comparePoints got to case 4 and childA and childB are the same!");n=root.firstChild;while(n){if(n===childA)return-1;if(n===childB)return 1;n=n.nextSibling}throw new Error("Should not be here!")}function fragmentFromNodeChildren(node){var fragment=getDocument(node).createDocumentFragment(),child;while(child=node.firstChild)fragment.appendChild(child);return fragment}function inspectNode(node){if(!node)return"[No node]";if(isCharacterDataNode(node))return'"'+node.data+'"';if(node.nodeType==1){var idAttr=node.id?' id="'+node.id+'"':"";return"<"+node.nodeName+idAttr+">["+node.childNodes.length+"]"}return node.nodeName}function NodeIterator(root){this.root=root,this._next=root}function createIterator(root){return new NodeIterator(root)}function DomPosition(node,offset){this.node=node,this.offset=offset}function DOMException(codeName){this.code=this[codeName],this.codeName=codeName,this.message="DOMException: "+this.codeName}var UNDEF="undefined",util=api.util;util.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||module.fail("document missing a Node creation method"),util.isHostMethod(document,"getElementsByTagName")||module.fail("document missing getElementsByTagName method");var el=document.createElement("div");util.areHostMethods(el,["insertBefore","appendChild","cloneNode"]||!util.areHostObjects(el,["previousSibling","nextSibling","childNodes","parentNode"]))||module.fail("Incomplete Element implementation"),util.isHostProperty(el,"innerHTML")||module.fail("Element is missing innerHTML property");var textNode=document.createTextNode("test");util.areHostMethods(textNode,["splitText","deleteData","insertData","appendData","cloneNode"]||!util.areHostObjects(el,["previousSibling","nextSibling","childNodes","parentNode"])||!util.areHostProperties(textNode,["data"]))||module.fail("Incomplete Text Node implementation");var arrayContains=function(arr,val){var i=arr.length;while(i--)if(arr[i]===val)return!0;return!1};NodeIterator.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var n=this._current=this._next,child,next;if(this._current){child=n.firstChild;if(child)this._next=child;else{next=null;while(n!==this.root&&!(next=n.nextSibling))n=n.parentNode;this._next=next}}return this._current},detach:function(){this._current=this._next=this.root=null}},DomPosition.prototype={equals:function(pos){return this.node===pos.node&this.offset==pos.offset},inspect:function(){return"[DomPosition("+inspectNode(this.node)+":"+this.offset+")]"}},DOMException.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},DOMException.prototype.toString=function(){return this.message},api.dom={arrayContains:arrayContains,isHtmlNamespace:isHtmlNamespace,parentElement:parentElement,getNodeIndex:getNodeIndex,getNodeLength:getNodeLength,getCommonAncestor:getCommonAncestor,isAncestorOf:isAncestorOf,getClosestAncestorIn:getClosestAncestorIn,isCharacterDataNode:isCharacterDataNode,insertAfter:insertAfter,splitDataNode:splitDataNode,getDocument:getDocument,getWindow:getWindow,getIframeWindow:getIframeWindow,getIframeDocument:getIframeDocument,getBody:getBody,getRootContainer:getRootContainer,comparePoints:comparePoints,inspectNode:inspectNode,fragmentFromNodeChildren:fragmentFromNodeChildren,createIterator:createIterator,DomPosition:DomPosition},api.DOMException=DOMException}),rangy.createModule("DomRange",function(api,module){function isNonTextPartiallySelected(node,range){return node.nodeType!=3&&(dom.isAncestorOf(node,range.startContainer,!0)||dom.isAncestorOf(node,range.endContainer,!0))}function getRangeDocument(range){return dom.getDocument(range.startContainer)}function dispatchEvent(range,type,args){var listeners=range._listeners[type];if(listeners)for(var i=0,len=listeners.length;i<len;++i)listeners[i].call(range,{target:range,args:args})}function getBoundaryBeforeNode(node){return new DomPosition(node.parentNode,dom.getNodeIndex(node))}function getBoundaryAfterNode(node){return new DomPosition(node.parentNode,dom.getNodeIndex(node)+1)}function insertNodeAtPosition(node,n,o){var firstNodeInserted=node.nodeType==11?node.firstChild:node;return dom.isCharacterDataNode(n)?o==n.length?dom.insertAfter(node,n):n.parentNode.insertBefore(node,o==0?n:dom.splitDataNode(n,o)):o>=n.childNodes.length?n.appendChild(node):n.insertBefore(node,n.childNodes[o]),firstNodeInserted}function cloneSubtree(iterator){var partiallySelected;for(var node,frag=getRangeDocument(iterator.range).createDocumentFragment(),subIterator;node=iterator.next();){partiallySelected=iterator.isPartiallySelectedSubtree(),node=node.cloneNode(!partiallySelected),partiallySelected&&(subIterator=iterator.getSubtreeIterator(),node.appendChild(cloneSubtree(subIterator)),subIterator.detach(!0));if(node.nodeType==10)throw new DOMException("HIERARCHY_REQUEST_ERR");frag.appendChild(node)}return frag}function iterateSubtree(rangeIterator,func,iteratorState){var it,n;iteratorState=iteratorState||{stop:!1};for(var node,subRangeIterator;node=rangeIterator.next();)if(rangeIterator.isPartiallySelectedSubtree()){if(func(node)===!1){iteratorState.stop=!0;return}subRangeIterator=rangeIterator.getSubtreeIterator(),iterateSubtree(subRangeIterator,func,iteratorState),subRangeIterator.detach(!0);if(iteratorState.stop)return}else{it=dom.createIterator(node);while(n=it.next())if(func(n)===!1){iteratorState.stop=!0;return}}}function deleteSubtree(iterator){var subIterator;while(iterator.next())iterator.isPartiallySelectedSubtree()?(subIterator=iterator.getSubtreeIterator(),deleteSubtree(subIterator),subIterator.detach(!0)):iterator.remove()}function extractSubtree(iterator){for(var node,frag=getRangeDocument(iterator.range).createDocumentFragment(),subIterator;node=iterator.next();){iterator.isPartiallySelectedSubtree()?(node=node.cloneNode(!1),subIterator=iterator.getSubtreeIterator(),node.appendChild(extractSubtree(subIterator)),subIterator.detach(!0)):iterator.remove();if(node.nodeType==10)throw new DOMException("HIERARCHY_REQUEST_ERR");frag.appendChild(node)}return frag}function getNodesInRange(range,nodeTypes,filter){var filterNodeTypes=!!nodeTypes&&!!nodeTypes.length,regex,filterExists=!!filter;filterNodeTypes&&(regex=new RegExp("^("+nodeTypes.join("|")+")$"));var nodes=[];return iterateSubtree(new RangeIterator(range,!1),function(node){(!filterNodeTypes||regex.test(node.nodeType))&&(!filterExists||filter(node))&&nodes.push(node)}),nodes}function inspect(range){var name=typeof range.getName=="undefined"?"Range":range.getName();return"["+name+"("+dom.inspectNode(range.startContainer)+":"+range.startOffset+", "+dom.inspectNode(range.endContainer)+":"+range.endOffset+")]"}function RangeIterator(range,clonePartiallySelectedTextNodes){this.range=range,this.clonePartiallySelectedTextNodes=clonePartiallySelectedTextNodes;if(!range.collapsed){this.sc=range.startContainer,this.so=range.startOffset,this.ec=range.endContainer,this.eo=range.endOffset;var root=range.commonAncestorContainer;this.sc===this.ec&&dom.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===root&&!dom.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:dom.getClosestAncestorIn(this.sc,root,!0),this._last=this.ec===root&&!dom.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:dom.getClosestAncestorIn(this.ec,root,!0))}}function RangeException(codeName){this.code=this[codeName],this.codeName=codeName,this.message="RangeException: "+this.codeName}function RangeNodeIterator(range,nodeTypes,filter){this.nodes=getNodesInRange(range,nodeTypes,filter),this._next=this.nodes[0],this._position=0}function createAncestorFinder(nodeTypes){return function(node,selfIsAncestor){var t,n=selfIsAncestor?node:node.parentNode;while(n){t=n.nodeType;if(dom.arrayContains(nodeTypes,t))return n;n=n.parentNode}return null}}function assertNoDocTypeNotationEntityAncestor(node,allowSelf){if(getDocTypeNotationEntityAncestor(node,allowSelf))throw new RangeException("INVALID_NODE_TYPE_ERR")}function assertNotDetached(range){if(!range.startContainer)throw new DOMException("INVALID_STATE_ERR")}function assertValidNodeType(node,invalidTypes){if(!dom.arrayContains(invalidTypes,node.nodeType))throw new RangeException("INVALID_NODE_TYPE_ERR")}function assertValidOffset(node,offset){if(offset<0||offset>(dom.isCharacterDataNode(node)?node.length:node.childNodes.length))throw new DOMException("INDEX_SIZE_ERR")}function assertSameDocumentOrFragment(node1,node2){if(getDocumentOrFragmentContainer(node1,!0)!==getDocumentOrFragmentContainer(node2,!0))throw new DOMException("WRONG_DOCUMENT_ERR")}function assertNodeNotReadOnly(node){if(getReadonlyAncestor(node,!0))throw new DOMException("NO_MODIFICATION_ALLOWED_ERR")}function assertNode(node,codeName){if(!node)throw new DOMException(codeName)}function isOrphan(node){return!dom.arrayContains(rootContainerNodeTypes,node.nodeType)&&!getDocumentOrFragmentContainer(node,!0)}function isValidOffset(node,offset){return offset<=(dom.isCharacterDataNode(node)?node.length:node.childNodes.length)}function assertRangeValid(range){assertNotDetached(range);if(isOrphan(range.startContainer)||isOrphan(range.endContainer)||!isValidOffset(range.startContainer,range.startOffset)||!isValidOffset(range.endContainer,range.endOffset))throw new Error("Range error: Range is no longer valid after DOM mutation ("+range.inspect()+")")}function RangePrototype(){}function copyComparisonConstantsToObject(obj){obj.START_TO_START=s2s,obj.START_TO_END=s2e,obj.END_TO_END=e2e,obj.END_TO_START=e2s,obj.NODE_BEFORE=n_b,obj.NODE_AFTER=n_a,obj.NODE_BEFORE_AND_AFTER=n_b_a,obj.NODE_INSIDE=n_i}function copyComparisonConstants(constructor){copyComparisonConstantsToObject(constructor),copyComparisonConstantsToObject(constructor.prototype)}function createRangeContentRemover(remover,boundaryUpdater){return function(){assertRangeValid(this);var sc=this.startContainer,so=this.startOffset,root=this.commonAncestorContainer,iterator=new RangeIterator(this,!0),node,boundary;sc!==root&&(node=dom.getClosestAncestorIn(sc,root,!0),boundary=getBoundaryAfterNode(node),sc=boundary.node,so=boundary.offset),iterateSubtree(iterator,assertNodeNotReadOnly),iterator.reset();var returnValue=remover(iterator);return iterator.detach(),boundaryUpdater(this,sc,so,sc,so),returnValue}}function createPrototypeRange(constructor,boundaryUpdater,detacher){function createBeforeAfterNodeSetter(isBefore,isStart){return function(node){assertNotDetached(this),assertValidNodeType(node,beforeAfterNodeTypes),assertValidNodeType(getRootContainer(node),rootContainerNodeTypes);var boundary=(isBefore?getBoundaryBeforeNode:getBoundaryAfterNode)(node);(isStart?setRangeStart:setRangeEnd)(this,boundary.node,boundary.offset)}}function setRangeStart(range,node,offset){var ec=range.endContainer,eo=range.endOffset;if(node!==range.startContainer||offset!==range.startOffset){if(getRootContainer(node)!=getRootContainer(ec)||dom.comparePoints(node,offset,ec,eo)==1)ec=node,eo=offset;boundaryUpdater(range,node,offset,ec,eo)}}function setRangeEnd(range,node,offset){var sc=range.startContainer,so=range.startOffset;if(node!==range.endContainer||offset!==range.endOffset){if(getRootContainer(node)!=getRootContainer(sc)||dom.comparePoints(node,offset,sc,so)==-1)sc=node,so=offset;boundaryUpdater(range,sc,so,node,offset)}}function setRangeStartAndEnd(range,node,offset){(node!==range.startContainer||offset!==range.startOffset||node!==range.endContainer||offset!==range.endOffset)&&boundaryUpdater(range,node,offset,node,offset)}constructor.prototype=new RangePrototype,api.util.extend(constructor.prototype,{setStart:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeStart(this,node,offset)},setEnd:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeEnd(this,node,offset)},setStartBefore:createBeforeAfterNodeSetter(!0,!0),setStartAfter:createBeforeAfterNodeSetter(!1,!0),setEndBefore:createBeforeAfterNodeSetter(!0,!1),setEndAfter:createBeforeAfterNodeSetter(!1,!1),collapse:function(isStart){assertRangeValid(this),isStart?boundaryUpdater(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):boundaryUpdater(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(node){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),boundaryUpdater(this,node,0,node,dom.getNodeLength(node))},selectNode:function(node){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!1),assertValidNodeType(node,beforeAfterNodeTypes);var start=getBoundaryBeforeNode(node),end=getBoundaryAfterNode(node);boundaryUpdater(this,start.node,start.offset,end.node,end.offset)},extractContents:createRangeContentRemover(extractSubtree,boundaryUpdater),deleteContents:createRangeContentRemover(deleteSubtree,boundaryUpdater),canSurroundContents:function(){assertRangeValid(this),assertNodeNotReadOnly(this.startContainer),assertNodeNotReadOnly(this.endContainer);var iterator=new RangeIterator(this,!0),boundariesInvalid=iterator._first&&isNonTextPartiallySelected(iterator._first,this)||iterator._last&&isNonTextPartiallySelected(iterator._last,this);return iterator.detach(),!boundariesInvalid},detach:function(){detacher(this)},splitBoundaries:function(){assertRangeValid(this);var sc=this.startContainer,so=this.startOffset,ec=this.endContainer,eo=this.endOffset,startEndSame=sc===ec;dom.isCharacterDataNode(ec)&&eo>0&&eo<ec.length&&dom.splitDataNode(ec,eo),dom.isCharacterDataNode(sc)&&so>0&&so<sc.length&&(sc=dom.splitDataNode(sc,so),startEndSame?(eo-=so,ec=sc):ec==sc.parentNode&&eo>=dom.getNodeIndex(sc)&&eo++,so=0),boundaryUpdater(this,sc,so,ec,eo)},normalizeBoundaries:function(){assertRangeValid(this);var sc=this.startContainer,so=this.startOffset,ec=this.endContainer,eo=this.endOffset,mergeForward=function(node){var sibling=node.nextSibling;sibling&&sibling.nodeType==node.nodeType&&(ec=node,eo=node.length,node.appendData(sibling.data),sibling.parentNode.removeChild(sibling))},mergeBackward=function(node){var sibling=node.previousSibling;if(sibling&&sibling.nodeType==node.nodeType){sc=node;var nodeLength=node.length;so=sibling.length,node.insertData(0,sibling.data),sibling.parentNode.removeChild(sibling);if(sc==ec)eo+=so,ec=sc;else if(ec==node.parentNode){var nodeIndex=dom.getNodeIndex(node);eo==nodeIndex?(ec=node,eo=nodeLength):eo>nodeIndex&&eo--}}},normalizeStart=!0;if(dom.isCharacterDataNode(ec))ec.length==eo&&mergeForward(ec);else{if(eo>0){var endNode=ec.childNodes[eo-1];endNode&&dom.isCharacterDataNode(endNode)&&mergeForward(endNode)}normalizeStart=!this.collapsed}if(normalizeStart){if(dom.isCharacterDataNode(sc))so==0&&mergeBackward(sc);else if(so<sc.childNodes.length){var startNode=sc.childNodes[so];startNode&&dom.isCharacterDataNode(startNode)&&mergeBackward(startNode)}}else sc=ec,so=eo;boundaryUpdater(this,sc,so,ec,eo)},collapseToPoint:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeStartAndEnd(this,node,offset)}}),copyComparisonConstants(constructor)}function updateCollapsedAndCommonAncestor(range){range.collapsed=range.startContainer===range.endContainer&&range.startOffset===range.endOffset,range.commonAncestorContainer=range.collapsed?range.startContainer:dom.getCommonAncestor(range.startContainer,range.endContainer)}function updateBoundaries(range,startContainer,startOffset,endContainer,endOffset){var startMoved=range.startContainer!==startContainer||range.startOffset!==startOffset,endMoved=range.endContainer!==endContainer||range.endOffset!==endOffset;range.startContainer=startContainer,range.startOffset=startOffset,range.endContainer=endContainer,range.endOffset=endOffset,updateCollapsedAndCommonAncestor(range),dispatchEvent(range,"boundarychange",{startMoved:startMoved,endMoved:endMoved})}function detach(range){assertNotDetached(range),range.startContainer=range.startOffset=range.endContainer=range.endOffset=null,range.collapsed=range.commonAncestorContainer=null,dispatchEvent(range,"detach",null),range._listeners=null}function Range(doc){this.startContainer=doc,this.startOffset=0,this.endContainer=doc,this.endOffset=0,this._listeners={boundarychange:[],detach:[]},updateCollapsedAndCommonAncestor(this)}api.requireModules(["DomUtil"]);var dom=api.dom,DomPosition=dom.DomPosition,DOMException=api.DOMException;RangeIterator.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var current=this._current=this._next;return current&&(this._next=current!==this._last?current.nextSibling:null,dom.isCharacterDataNode(current)&&this.clonePartiallySelectedTextNodes&&(current===this.ec&&(current=current.cloneNode(!0)).deleteData(this.eo,current.length-this.eo),this._current===this.sc&&(current=current.cloneNode(!0)).deleteData(0,this.so))),current},remove:function(){var current=this._current,start,end;!dom.isCharacterDataNode(current)||current!==this.sc&&current!==this.ec?current.parentNode&&current.parentNode.removeChild(current):(start=current===this.sc?this.so:0,end=current===this.ec?this.eo:current.length,start!=end&&current.deleteData(start,end-start))},isPartiallySelectedSubtree:function(){var current=this._current;return isNonTextPartiallySelected(current,this.range)},getSubtreeIterator:function(){var subRange;if(this.isSingleCharacterDataNode)subRange=this.range.cloneRange(),subRange.collapse();else{subRange=new Range(getRangeDocument(this.range));var current=this._current,startContainer=current,startOffset=0,endContainer=current,endOffset=dom.getNodeLength(current);dom.isAncestorOf(current,this.sc,!0)&&(startContainer=this.sc,startOffset=this.so),dom.isAncestorOf(current,this.ec,!0)&&(endContainer=this.ec,endOffset=this.eo),updateBoundaries(subRange,startContainer,startOffset,endContainer,endOffset)}return new RangeIterator(subRange,this.clonePartiallySelectedTextNodes)},detach:function(detachRange){detachRange&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},RangeException.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},RangeException.prototype.toString=function(){return this.message},RangeNodeIterator.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){return this._current=this._next,this._next=this.nodes[++this._position],this._current},detach:function(){this._current=this._next=this.nodes=null}};var beforeAfterNodeTypes=[1,3,4,5,7,8,10],rootContainerNodeTypes=[2,9,11],readonlyNodeTypes=[5,6,10,12],insertableNodeTypes=[1,3,4,5,7,8,10,11],surroundNodeTypes=[1,3,4,5,7,8],getRootContainer=dom.getRootContainer,getDocumentOrFragmentContainer=createAncestorFinder([9,11]),getReadonlyAncestor=createAncestorFinder(readonlyNodeTypes),getDocTypeNotationEntityAncestor=createAncestorFinder([6,10,12]),styleEl=document.createElement("style"),htmlParsingConforms=!1;try{styleEl.innerHTML="<b>x</b>",htmlParsingConforms=styleEl.firstChild.nodeType==3}catch(e){}api.features.htmlParsingConforms=htmlParsingConforms;var createContextualFragment=htmlParsingConforms?function(fragmentStr){var node=this.startContainer,doc=dom.getDocument(node);if(!node)throw new DOMException("INVALID_STATE_ERR");var el=null;return node.nodeType==1?el=node:dom.isCharacterDataNode(node)&&(el=dom.parentElement(node)),el===null||el.nodeName=="HTML"&&dom.isHtmlNamespace(dom.getDocument(el).documentElement)&&dom.isHtmlNamespace(el)?el=doc.createElement("body"):el=el.cloneNode(!1),el.innerHTML=fragmentStr,dom.fragmentFromNodeChildren(el)}:function(fragmentStr){assertNotDetached(this);var doc=getRangeDocument(this),el=doc.createElement("body");return el.innerHTML=fragmentStr,dom.fragmentFromNodeChildren(el)},rangeProperties=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],s2s=0,s2e=1,e2e=2,e2s=3,n_b=0,n_a=1,n_b_a=2,n_i=3;RangePrototype.prototype={attachListener:function(type,listener){this._listeners[type].push(listener)},compareBoundaryPoints:function(how,range){assertRangeValid(this),assertSameDocumentOrFragment(this.startContainer,range.startContainer);var nodeA,offsetA,nodeB,offsetB,prefixA=how==e2s||how==s2s?"start":"end",prefixB=how==s2e||how==s2s?"start":"end";return nodeA=this[prefixA+"Container"],offsetA=this[prefixA+"Offset"],nodeB=range[prefixB+"Container"],offsetB=range[prefixB+"Offset"],dom.comparePoints(nodeA,offsetA,nodeB,offsetB)},insertNode:function(node){assertRangeValid(this),assertValidNodeType(node,insertableNodeTypes),assertNodeNotReadOnly(this.startContainer);if(dom.isAncestorOf(node,this.startContainer,!0))throw new DOMException("HIERARCHY_REQUEST_ERR");var firstNodeInserted=insertNodeAtPosition(node,this.startContainer,this.startOffset);this.setStartBefore(firstNodeInserted)},cloneContents:function(){assertRangeValid(this);var clone,frag;if(this.collapsed)return getRangeDocument(this).createDocumentFragment();if(this.startContainer===this.endContainer&&dom.isCharacterDataNode(this.startContainer))return clone=this.startContainer.cloneNode(!0),clone.data=clone.data.slice(this.startOffset,this.endOffset),frag=getRangeDocument(this).createDocumentFragment(),frag.appendChild(clone),frag;var iterator=new RangeIterator(this,!0);return clone=cloneSubtree(iterator),iterator.detach(),clone},canSurroundContents:function(){assertRangeValid(this),assertNodeNotReadOnly(this.startContainer),assertNodeNotReadOnly(this.endContainer);var iterator=new RangeIterator(this,!0),boundariesInvalid=iterator._first&&isNonTextPartiallySelected(iterator._first,this)||iterator._last&&isNonTextPartiallySelected(iterator._last,this);return iterator.detach(),!boundariesInvalid},surroundContents:function(node){assertValidNodeType(node,surroundNodeTypes);if(!this.canSurroundContents())throw new RangeException("BAD_BOUNDARYPOINTS_ERR");var content=this.extractContents();if(node.hasChildNodes())while(node.lastChild)node.removeChild(node.lastChild);insertNodeAtPosition(node,this.startContainer,this.startOffset),node.appendChild(content),this.selectNode(node)},cloneRange:function(){assertRangeValid(this);var range=new Range(getRangeDocument(this)),i=rangeProperties.length,prop;while(i--)prop=rangeProperties[i],range[prop]=this[prop];return range},toString:function(){assertRangeValid(this);var sc=this.startContainer;if(sc===this.endContainer&&dom.isCharacterDataNode(sc))return sc.nodeType==3||sc.nodeType==4?sc.data.slice(this.startOffset,this.endOffset):"";var textBits=[],iterator=new RangeIterator(this,!0);return iterateSubtree(iterator,function(node){(node.nodeType==3||node.nodeType==4)&&textBits.push(node.data)}),iterator.detach(),textBits.join("")},compareNode:function(node){assertRangeValid(this);var parent=node.parentNode,nodeIndex=dom.getNodeIndex(node);if(!parent)throw new DOMException("NOT_FOUND_ERR");var startComparison=this.comparePoint(parent,nodeIndex),endComparison=this.comparePoint(parent,nodeIndex+1);return startComparison<0?endComparison>0?n_b_a:n_b:endComparison>0?n_a:n_i},comparePoint:function(node,offset){return assertRangeValid(this),assertNode(node,"HIERARCHY_REQUEST_ERR"),assertSameDocumentOrFragment(node,this.startContainer),dom.comparePoints(node,offset,this.startContainer,this.startOffset)<0?-1:dom.comparePoints(node,offset,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:createContextualFragment,toHtml:function(){assertRangeValid(this);var container=getRangeDocument(this).createElement("div");return container.appendChild(this.cloneContents()),container.innerHTML},intersectsNode:function(node,touchingIsIntersecting){assertRangeValid(this),assertNode(node,"NOT_FOUND_ERR");if(dom.getDocument(node)!==getRangeDocument(this))return!1;var parent=node.parentNode,offset=dom.getNodeIndex(node);assertNode(parent,"NOT_FOUND_ERR");var startComparison=dom.comparePoints(parent,offset,this.endContainer,this.endOffset),endComparison=dom.comparePoints(parent,offset+1,this.startContainer,this.startOffset);return touchingIsIntersecting?startComparison<=0&&endComparison>=0:startComparison<0&&endComparison>0},isPointInRange:function(node,offset){return assertRangeValid(this),assertNode(node,"HIERARCHY_REQUEST_ERR"),assertSameDocumentOrFragment(node,this.startContainer),dom.comparePoints(node,offset,this.startContainer,this.startOffset)>=0&&dom.comparePoints(node,offset,this.endContainer,this.endOffset)<=0},intersectsRange:function(range,touchingIsIntersecting){assertRangeValid(this);if(getRangeDocument(range)!=getRangeDocument(this))throw new DOMException("WRONG_DOCUMENT_ERR");var startComparison=dom.comparePoints(this.startContainer,this.startOffset,range.endContainer,range.endOffset),endComparison=dom.comparePoints(this.endContainer,this.endOffset,range.startContainer,range.startOffset);return touchingIsIntersecting?startComparison<=0&&endComparison>=0:startComparison<0&&endComparison>0},intersection:function(range){if(this.intersectsRange(range)){var startComparison=dom.comparePoints(this.startContainer,this.startOffset,range.startContainer,range.startOffset),endComparison=dom.comparePoints(this.endContainer,this.endOffset,range.endContainer,range.endOffset),intersectionRange=this.cloneRange();return startComparison==-1&&intersectionRange.setStart(range.startContainer,range.startOffset),endComparison==1&&intersectionRange.setEnd(range.endContainer,range.endOffset),intersectionRange}return null},union:function(range){if(this.intersectsRange(range,!0)){var unionRange=this.cloneRange();return dom.comparePoints(range.startContainer,range.startOffset,this.startContainer,this.startOffset)==-1&&unionRange.setStart(range.startContainer,range.startOffset),dom.comparePoints(range.endContainer,range.endOffset,this.endContainer,this.endOffset)==1&&unionRange.setEnd(range.endContainer,range.endOffset),unionRange}throw new RangeException("Ranges do not intersect")},containsNode:function(node,allowPartial){return allowPartial?this.intersectsNode(node,!1):this.compareNode(node)==n_i},containsNodeContents:function(node){return this.comparePoint(node,0)>=0&&this.comparePoint(node,dom.getNodeLength(node))<=0},containsRange:function(range){return this.intersection(range).equals(range)},containsNodeText:function(node){var nodeRange=this.cloneRange();nodeRange.selectNode(node);var textNodes=nodeRange.getNodes([3]);if(textNodes.length>0){nodeRange.setStart(textNodes[0],0);var lastTextNode=textNodes.pop();nodeRange.setEnd(lastTextNode,lastTextNode.length);var contains=this.containsRange(nodeRange);return nodeRange.detach(),contains}return this.containsNodeContents(node)},createNodeIterator:function(nodeTypes,filter){return assertRangeValid(this),new RangeNodeIterator(this,nodeTypes,filter)},getNodes:function(nodeTypes,filter){return assertRangeValid(this),getNodesInRange(this,nodeTypes,filter)},getDocument:function(){return getRangeDocument(this)},collapseBefore:function(node){assertNotDetached(this),this.setEndBefore(node),this.collapse(!1)},collapseAfter:function(node){assertNotDetached(this),this.setStartAfter(node),this.collapse(!0)},getName:function(){return"DomRange"},equals:function(range){return Range.rangesEqual(this,range)},inspect:function(){return inspect(this)}},createPrototypeRange(Range,updateBoundaries,detach),api.rangePrototype=RangePrototype.prototype,Range.rangeProperties=rangeProperties,Range.RangeIterator=RangeIterator,Range.copyComparisonConstants=copyComparisonConstants,Range.createPrototypeRange=createPrototypeRange,Range.inspect=inspect,Range.getRangeDocument=getRangeDocument,Range.rangesEqual=function(r1,r2){return r1.startContainer===r2.startContainer&&r1.startOffset===r2.startOffset&&r1.endContainer===r2.endContainer&&r1.endOffset===r2.endOffset},api.DomRange=Range,api.RangeException=RangeException}),rangy.createModule("WrappedRange",function(api,module){function getTextRangeContainerElement(textRange){var parentEl=textRange.parentElement(),range=textRange.duplicate();range.collapse(!0);var startEl=range.parentElement();range=textRange.duplicate(),range.collapse(!1);var endEl=range.parentElement(),startEndContainer=startEl==endEl?startEl:dom.getCommonAncestor(startEl,endEl);return startEndContainer==parentEl?startEndContainer:dom.getCommonAncestor(parentEl,startEndContainer)}function textRangeIsCollapsed(textRange){return textRange.compareEndPoints("StartToEnd",textRange)==0}function getTextRangeBoundaryPosition(textRange,wholeRangeContainerElement,isStart,isCollapsed){var workingRange=textRange.duplicate();workingRange.collapse(isStart);var containerElement=workingRange.parentElement();dom.isAncestorOf(wholeRangeContainerElement,containerElement,!0)||(containerElement=wholeRangeContainerElement);if(!containerElement.canHaveHTML)return new DomPosition(containerElement.parentNode,dom.getNodeIndex(containerElement));var workingNode=dom.getDocument(containerElement).createElement("span"),comparison,workingComparisonType=isStart?"StartToStart":"StartToEnd",previousNode,nextNode,boundaryPosition,boundaryNode;do containerElement.insertBefore(workingNode,workingNode.previousSibling),workingRange.moveToElementText(workingNode);while((comparison=workingRange.compareEndPoints(workingComparisonType,textRange))>0&&workingNode.previousSibling);boundaryNode=workingNode.nextSibling;if(comparison==-1&&boundaryNode&&dom.isCharacterDataNode(boundaryNode)){workingRange.setEndPoint(isStart?"EndToStart":"EndToEnd",textRange);var offset;if(/[\r\n]/.test(boundaryNode.data)){var tempRange=workingRange.duplicate(),rangeLength=tempRange.text.replace(/\r\n/g,"\r").length;offset=tempRange.moveStart("character",rangeLength);while((comparison=tempRange.compareEndPoints("StartToEnd",tempRange))==-1)offset++,tempRange.moveStart("character",1)}else offset=workingRange.text.length;boundaryPosition=new DomPosition(boundaryNode,offset)}else previousNode=(isCollapsed||!isStart)&&workingNode.previousSibling,nextNode=(isCollapsed||isStart)&&workingNode.nextSibling,nextNode&&dom.isCharacterDataNode(nextNode)?boundaryPosition=new DomPosition(nextNode,0):previousNode&&dom.isCharacterDataNode(previousNode)?boundaryPosition=new DomPosition(previousNode,previousNode.length):boundaryPosition=new DomPosition(containerElement,dom.getNodeIndex(workingNode));return workingNode.parentNode.removeChild(workingNode),boundaryPosition}function createBoundaryTextRange(boundaryPosition,isStart){var boundaryNode,boundaryParent,boundaryOffset=boundaryPosition.offset,doc=dom.getDocument(boundaryPosition.node),workingNode,childNodes,workingRange=doc.body.createTextRange(),nodeIsDataNode=dom.isCharacterDataNode(boundaryPosition.node);return nodeIsDataNode?(boundaryNode=boundaryPosition.node,boundaryParent=boundaryNode.parentNode):(childNodes=boundaryPosition.node.childNodes,boundaryNode=boundaryOffset<childNodes.length?childNodes[boundaryOffset]:null,boundaryParent=boundaryPosition.node),workingNode=doc.createElement("span"),workingNode.innerHTML="&#feff;",boundaryNode?boundaryParent.insertBefore(workingNode,boundaryNode):boundaryParent.appendChild(workingNode),workingRange.moveToElementText(workingNode),workingRange.collapse(!isStart),boundaryParent.removeChild(workingNode),nodeIsDataNode&&workingRange[isStart?"moveStart":"moveEnd"]("character",boundaryOffset),workingRange}api.requireModules(["DomUtil","DomRange"]);var WrappedRange,dom=api.dom,DomPosition=dom.DomPosition,DomRange=api.DomRange;if(api.features.implementsDomRange&&(!api.features.implementsTextRange||!api.config.preferTextRange))(function(){function updateRangeProperties(range){var i=rangeProperties.length,prop;while(i--)prop=rangeProperties[i],range[prop]=range.nativeRange[prop]}function updateNativeRange(range,startContainer,startOffset,endContainer,endOffset){var startMoved=range.startContainer!==startContainer||range.startOffset!=startOffset,endMoved=range.endContainer!==endContainer||range.endOffset!=endOffset;if(startMoved||endMoved)range.setEnd(endContainer,endOffset),range.setStart(startContainer,startOffset)}function detach(range){range.nativeRange.detach(),range.detached=!0;var i=rangeProperties.length,prop;while(i--)prop=rangeProperties[i],range[prop]=null}var rangeProto,rangeProperties=DomRange.rangeProperties,canSetRangeStartAfterEnd,createBeforeAfterNodeSetter;WrappedRange=function(range){if(!range)throw new Error("Range must be specified");this.nativeRange=range,updateRangeProperties(this)},DomRange.createPrototypeRange(WrappedRange,updateNativeRange,detach),rangeProto=WrappedRange.prototype,rangeProto.selectNode=function(node){this.nativeRange.selectNode(node),updateRangeProperties(this)},rangeProto.deleteContents=function(){this.nativeRange.deleteContents(),updateRangeProperties(this)},rangeProto.extractContents=function(){var frag=this.nativeRange.extractContents();return updateRangeProperties(this),frag},rangeProto.cloneContents=function(){return this.nativeRange.cloneContents()},rangeProto.surroundContents=function(node){this.nativeRange.surroundContents(node),updateRangeProperties(this)},rangeProto.collapse=function(isStart){this.nativeRange.collapse(isStart),updateRangeProperties(this)},rangeProto.cloneRange=function(){return new WrappedRange(this.nativeRange.cloneRange())},rangeProto.refresh=function(){updateRangeProperties(this)},rangeProto.toString=function(){return this.nativeRange.toString()};var testTextNode=document.createTextNode("test");dom.getBody(document).appendChild(testTextNode);var range=document.createRange();range.setStart(testTextNode,0),range.setEnd(testTextNode,0);try{range.setStart(testTextNode,1),canSetRangeStartAfterEnd=!0,rangeProto.setStart=function(node,offset){this.nativeRange.setStart(node,offset),updateRangeProperties(this)},rangeProto.setEnd=function(node,offset){this.nativeRange.setEnd(node,offset),updateRangeProperties(this)},createBeforeAfterNodeSetter=function(name){return function(node){this.nativeRange[name](node),updateRangeProperties(this)}}}catch(ex){canSetRangeStartAfterEnd=!1,rangeProto.setStart=function(node,offset){try{this.nativeRange.setStart(node,offset)}catch(ex){this.nativeRange.setEnd(node,offset),this.nativeRange.setStart(node,offset)}updateRangeProperties(this)},rangeProto.setEnd=function(node,offset){try{this.nativeRange.setEnd(node,offset)}catch(ex){this.nativeRange.setStart(node,offset),this.nativeRange.setEnd(node,offset)}updateRangeProperties(this)},createBeforeAfterNodeSetter=function(name,oppositeName){return function(node){try{this.nativeRange[name](node)}catch(ex){this.nativeRange[oppositeName](node),this.nativeRange[name](node)}updateRangeProperties(this)}}}rangeProto.setStartBefore=createBeforeAfterNodeSetter("setStartBefore","setEndBefore"),rangeProto.setStartAfter=createBeforeAfterNodeSetter("setStartAfter","setEndAfter"),rangeProto.setEndBefore=createBeforeAfterNodeSetter("setEndBefore","setStartBefore"),rangeProto.setEndAfter=createBeforeAfterNodeSetter("setEndAfter","setStartAfter"),range.selectNodeContents(testTextNode),range.startContainer==testTextNode&&range.endContainer==testTextNode&&range.startOffset==0&&range.endOffset==testTextNode.length?rangeProto.selectNodeContents=function(node){this.nativeRange.selectNodeContents(node),updateRangeProperties(this)}:rangeProto.selectNodeContents=function(node){this.setStart(node,0),this.setEnd(node,DomRange.getEndOffset(node))},range.selectNodeContents(testTextNode),range.setEnd(testTextNode,3);var range2=document.createRange();range2.selectNodeContents(testTextNode),range2.setEnd(testTextNode,4),range2.setStart(testTextNode,2),range.compareBoundaryPoints(range.START_TO_END,range2)==-1&range.compareBoundaryPoints(range.END_TO_START,range2)==1?rangeProto.compareBoundaryPoints=function(type,range){return range=range.nativeRange||range,type==range.START_TO_END?type=range.END_TO_START:type==range.END_TO_START&&(type=range.START_TO_END),this.nativeRange.compareBoundaryPoints(type,range)}:rangeProto.compareBoundaryPoints=function(type,range){return this.nativeRange.compareBoundaryPoints(type,range.nativeRange||range)},api.util.isHostMethod(range,"createContextualFragment")&&(rangeProto.createContextualFragment=function(fragmentStr){return this.nativeRange.createContextualFragment(fragmentStr)}),dom.getBody(document).removeChild(testTextNode),range.detach(),range2.detach()})(),api.createNativeRange=function(doc){return doc=doc||document,doc.createRange()};else if(api.features.implementsTextRange){WrappedRange=function(textRange){this.textRange=textRange,this.refresh()},WrappedRange.prototype=new DomRange(document),WrappedRange.prototype.refresh=function(){var start,end,rangeContainerElement=getTextRangeContainerElement(this.textRange);textRangeIsCollapsed(this.textRange)?end=start=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!0,!0):(start=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!0,!1),end=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!1,!1)),this.setStart(start.node,start.offset),this.setEnd(end.node,end.offset)},DomRange.copyComparisonConstants(WrappedRange);var globalObj=function(){return this}();typeof globalObj.Range=="undefined"&&(globalObj.Range=WrappedRange),api.createNativeRange=function(doc){return doc=doc||document,doc.body.createTextRange()}}api.features.implementsTextRange&&(WrappedRange.rangeToTextRange=function(range){if(range.collapsed){var tr=createBoundaryTextRange(new DomPosition(range.startContainer,range.startOffset),!0);return tr}var startRange=createBoundaryTextRange(new DomPosition(range.startContainer,range.startOffset),!0),endRange=createBoundaryTextRange(new DomPosition(range.endContainer,range.endOffset),!1),textRange=dom.getDocument(range.startContainer).body.createTextRange();return textRange.setEndPoint("StartToStart",startRange),textRange.setEndPoint("EndToEnd",endRange),textRange}),WrappedRange.prototype.getName=function(){return"WrappedRange"},api.WrappedRange=WrappedRange,api.createRange=function(doc){return doc=doc||document,new WrappedRange(api.createNativeRange(doc))},api.createRangyRange=function(doc){return doc=doc||document,new DomRange(doc)},api.createIframeRange=function(iframeEl){return api.createRange(dom.getIframeDocument(iframeEl))},api.createIframeRangyRange=function(iframeEl){return api.createRangyRange(dom.getIframeDocument(iframeEl))},api.addCreateMissingNativeApiListener(function(win){var doc=win.document;typeof doc.createRange=="undefined"&&(doc.createRange=function(){return api.createRange(this)}),doc=win=null})}),rangy.createModule("WrappedSelection",function(api,module){function getWinSelection(winParam){return(winParam||window).getSelection()}function getDocSelection(winParam){return(winParam||window).document.selection}function updateAnchorAndFocusFromRange(sel,range,backwards){var anchorPrefix=backwards?"end":"start",focusPrefix=backwards?"start":"end";sel.anchorNode=range[anchorPrefix+"Container"],sel.anchorOffset=range[anchorPrefix+"Offset"],sel.focusNode=range[focusPrefix+"Container"],sel.focusOffset=range[focusPrefix+"Offset"]}function updateAnchorAndFocusFromNativeSelection(sel){var nativeSel=sel.nativeSelection;sel.anchorNode=nativeSel.anchorNode,sel.anchorOffset=nativeSel.anchorOffset,sel.focusNode=nativeSel.focusNode,sel.focusOffset=nativeSel.focusOffset}function updateEmptySelection(sel){sel.anchorNode=sel.focusNode=null,sel.anchorOffset=sel.focusOffset=0,sel.rangeCount=0,sel.isCollapsed=!0,sel._ranges.length=0}function getNativeRange(range){var nativeRange;return range instanceof DomRange?(nativeRange=range._selectionNativeRange,nativeRange||(nativeRange=api.createNativeRange(dom.getDocument(range.startContainer)),nativeRange.setEnd(range.endContainer,range.endOffset),nativeRange.setStart(range.startContainer,range.startOffset),range._selectionNativeRange=nativeRange,range.attachListener("detach",function(){this._selectionNativeRange=null}))):range instanceof WrappedRange?nativeRange=range.nativeRange:api.features.implementsDomRange&&range instanceof dom.getWindow(range.startContainer).Range&&(nativeRange=range),nativeRange}function rangeContainsSingleElement(rangeNodes){if(!rangeNodes.length||rangeNodes[0].nodeType!=1)return!1;for(var i=1,len=rangeNodes.length;i<len;++i)if(!dom.isAncestorOf(rangeNodes[0],rangeNodes[i]))return!1;return!0}function getSingleElementFromRange(range){var nodes=range.getNodes();if(!rangeContainsSingleElement(nodes))throw new Error("getSingleElementFromRange: range "+range.inspect()+" did not consist of a single element");return nodes[0]}function isTextRange(range){return!!range&&typeof range.text!="undefined"}function updateFromTextRange(sel,range){var wrappedRange=new WrappedRange(range);sel._ranges=[wrappedRange],updateAnchorAndFocusFromRange(sel,wrappedRange,!1),sel.rangeCount=1,sel.isCollapsed=wrappedRange.collapsed}function updateControlSelection(sel){sel._ranges.length=0;if(sel.docSelection.type=="None")updateEmptySelection(sel);else{var controlRange=sel.docSelection.createRange();if(isTextRange(controlRange))updateFromTextRange(sel,controlRange);else{sel.rangeCount=controlRange.length;var range,doc=dom.getDocument(controlRange.item(0));for(var i=0;i<sel.rangeCount;++i)range=api.createRange(doc),range.selectNode(controlRange.item(i)),sel._ranges.push(range);sel.isCollapsed=sel.rangeCount==1&&sel._ranges[0].collapsed,updateAnchorAndFocusFromRange(sel,sel._ranges[sel.rangeCount-1],!1)}}}function addRangeToControlSelection(sel,range){var controlRange=sel.docSelection.createRange(),rangeElement=getSingleElementFromRange(range),doc=dom.getDocument(controlRange.item(0)),newControlRange=dom.getBody(doc).createControlRange();for(var i=0,len=controlRange.length;i<len;++i)newControlRange.add(controlRange.item(i));try{newControlRange.add(rangeElement)}catch(ex){throw new Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}newControlRange.select(),updateControlSelection(sel)}function WrappedSelection(selection,docSelection,win){this.nativeSelection=selection,this.docSelection=docSelection,this._ranges=[],this.win=win,this.refresh()}function createControlSelection(sel,ranges){var doc=dom.getDocument(ranges[0].startContainer),controlRange=dom.getBody(doc).createControlRange();for(var i=0,el;i<rangeCount;++i){el=getSingleElementFromRange(ranges[i]);try{controlRange.add(el)}catch(ex){throw new Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}controlRange.select(),updateControlSelection(sel)}function assertNodeInSameDocument(sel,node){if(sel.anchorNode&&dom.getDocument(sel.anchorNode)!==dom.getDocument(node))throw new DOMException("WRONG_DOCUMENT_ERR")}function inspect(sel){var rangeInspects=[],anchor=new DomPosition(sel.anchorNode,sel.anchorOffset),focus=new DomPosition(sel.focusNode,sel.focusOffset),name=typeof sel.getName=="function"?sel.getName():"Selection";if(typeof sel.rangeCount!="undefined")for(var i=0,len=sel.rangeCount;i<len;++i)rangeInspects[i]=DomRange.inspect(sel.getRangeAt(i));return"["+name+"(Ranges: "+rangeInspects.join(", ")+")(anchor: "+anchor.inspect()+", focus: "+focus.inspect()+"]"}api.requireModules(["DomUtil","DomRange","WrappedRange"]),api.config.checkSelectionRanges=!0;var BOOLEAN="boolean",windowPropertyName="_rangySelection",dom=api.dom,util=api.util,DomRange=api.DomRange,WrappedRange=api.WrappedRange,DOMException=api.DOMException,DomPosition=dom.DomPosition,getSelection,selectionIsCollapsed,CONTROL="Control",implementsWinGetSelection=api.util.isHostMethod(window,"getSelection"),implementsDocSelection=api.util.isHostObject(document,"selection"),useDocumentSelection=implementsDocSelection&&(!implementsWinGetSelection||api.config.preferTextRange);useDocumentSelection?(getSelection=getDocSelection,api.isSelectionValid=function(winParam){var doc=(winParam||window).document,nativeSel=doc.selection;return nativeSel.type!="None"||dom.getDocument(nativeSel.createRange().parentElement())==doc}):implementsWinGetSelection?(getSelection=getWinSelection,api.isSelectionValid=function(){return!0}):module.fail("Neither document.selection or window.getSelection() detected."),api.getNativeSelection=getSelection;var testSelection=getSelection(),testRange=api.createNativeRange(document),body=dom.getBody(document),selectionHasAnchorAndFocus=util.areHostObjects(testSelection,["anchorNode","focusNode"]&&util.areHostProperties(testSelection,["anchorOffset","focusOffset"]));api.features.selectionHasAnchorAndFocus=selectionHasAnchorAndFocus;var selectionHasExtend=util.isHostMethod(testSelection,"extend");api.features.selectionHasExtend=selectionHasExtend;var selectionHasRangeCount=typeof testSelection.rangeCount=="number";api.features.selectionHasRangeCount=selectionHasRangeCount;var selectionSupportsMultipleRanges=!1,collapsedNonEditableSelectionsSupported=!0;util.areHostMethods(testSelection,["addRange","getRangeAt","removeAllRanges"])&&typeof testSelection.rangeCount=="number"&&api.features.implementsDomRange&&function(){var iframe=document.createElement("iframe");body.appendChild(iframe);var iframeDoc=dom.getIframeDocument(iframe);iframeDoc.open(),iframeDoc.write("<html><head></head><body>12</body></html>"),iframeDoc.close();var sel=dom.getIframeWindow(iframe).getSelection(),docEl=iframeDoc.documentElement,iframeBody=docEl.lastChild,textNode=iframeBody.firstChild,r1=iframeDoc.createRange();r1.setStart(textNode,1),r1.collapse(!0),sel.addRange(r1),collapsedNonEditableSelectionsSupported=sel.rangeCount==1,sel.removeAllRanges();var r2=r1.cloneRange();r1.setStart(textNode,0),r2.setEnd(textNode,2),sel.addRange(r1),sel.addRange(r2),selectionSupportsMultipleRanges=sel.rangeCount==2,r1.detach(),r2.detach(),body.removeChild(iframe)}(),api.features.selectionSupportsMultipleRanges=selectionSupportsMultipleRanges,api.features.collapsedNonEditableSelectionsSupported=collapsedNonEditableSelectionsSupported;var implementsControlRange=!1,testControlRange;body&&util.isHostMethod(body,"createControlRange")&&(testControlRange=body.createControlRange(),util.areHostProperties(testControlRange,["item","add"])&&(implementsControlRange=!0)),api.features.implementsControlRange=implementsControlRange,selectionHasAnchorAndFocus?selectionIsCollapsed=function(sel){return sel.anchorNode===sel.focusNode&&sel.anchorOffset===sel.focusOffset}:selectionIsCollapsed=function(sel){return sel.rangeCount?sel.getRangeAt(sel.rangeCount-1).collapsed:!1};var getSelectionRangeAt;util.isHostMethod(testSelection,"getRangeAt")?getSelectionRangeAt=function(sel,index){try{return sel.getRangeAt(index)}catch(ex){return null}}:selectionHasAnchorAndFocus&&(getSelectionRangeAt=function(sel){var doc=dom.getDocument(sel.anchorNode),range=api.createRange(doc);return range.setStart(sel.anchorNode,sel.anchorOffset),range.setEnd(sel.focusNode,sel.focusOffset),range.collapsed!==this.isCollapsed&&(range.setStart(sel.focusNode,sel.focusOffset),range.setEnd(sel.anchorNode,sel.anchorOffset)),range}),api.getSelection=function(win){win=win||window;var sel=win[windowPropertyName],nativeSel=getSelection(win),docSel=implementsDocSelection?getDocSelection(win):null;return sel?(sel.nativeSelection=nativeSel,sel.docSelection=docSel,sel.refresh(win)):(sel=new WrappedSelection(nativeSel,docSel,win),win[windowPropertyName]=sel),sel},api.getIframeSelection=function(iframeEl){return api.getSelection(dom.getIframeWindow(iframeEl))};var selProto=WrappedSelection.prototype;if(!useDocumentSelection&&selectionHasAnchorAndFocus&&util.areHostMethods(testSelection,["removeAllRanges","addRange"])){selProto.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),updateEmptySelection(this)};var addRangeBackwards=function(sel,range){var doc=DomRange.getRangeDocument(range),endRange=api.createRange(doc);endRange.collapseToPoint(range.endContainer,range.endOffset),sel.nativeSelection.addRange(getNativeRange(endRange)),sel.nativeSelection.extend(range.startContainer,range.startOffset),sel.refresh()};selectionHasRangeCount?selProto.addRange=function(range,backwards){if(implementsControlRange&&implementsDocSelection&&this.docSelection.type==CONTROL)addRangeToControlSelection(this,range);else if(backwards&&selectionHasExtend)addRangeBackwards(this,range);else{var previousRangeCount;selectionSupportsMultipleRanges?previousRangeCount=this.rangeCount:(this.removeAllRanges(),previousRangeCount=0),this.nativeSelection.addRange(getNativeRange(range)),this.rangeCount=this.nativeSelection.rangeCount;if(this.rangeCount==previousRangeCount+1){if(api.config.checkSelectionRanges){var nativeRange=getSelectionRangeAt(this.nativeSelection,this.rangeCount-1);nativeRange&&!DomRange.rangesEqual(nativeRange,range)&&(range=new WrappedRange(nativeRange))}this._ranges[this.rangeCount-1]=range,updateAnchorAndFocusFromRange(this,range,selectionIsBackwards(this.nativeSelection)),this.isCollapsed=selectionIsCollapsed(this)}else this.refresh()}}:selProto.addRange=function(range,backwards){backwards&&selectionHasExtend?addRangeBackwards(this,range):(this.nativeSelection.addRange(getNativeRange(range)),this.refresh())},selProto.setRanges=function(ranges){if(implementsControlRange&&ranges.length>1)createControlSelection(this,ranges);else{this.removeAllRanges();for(var i=0,len=ranges.length;i<len;++i)this.addRange(ranges[i])}}}else{if(!(util.isHostMethod(testSelection,"empty")&&util.isHostMethod(testRange,"select")&&implementsControlRange&&useDocumentSelection))return module.fail("No means of selecting a Range or TextRange was found"),!1;selProto.removeAllRanges=function(){try{this.docSelection.empty();if(this.docSelection.type!="None"){var doc;if(this.anchorNode)doc=dom.getDocument(this.anchorNode);else if(this.docSelection.type==CONTROL){var controlRange=this.docSelection.createRange();controlRange.length&&(doc=dom.getDocument(controlRange.item(0)).body.createTextRange())}if(doc){var textRange=doc.body.createTextRange();textRange.select(),this.docSelection.empty()}}}catch(ex){}updateEmptySelection(this)},selProto.addRange=function(range){this.docSelection.type==CONTROL?addRangeToControlSelection(this,range):(WrappedRange.rangeToTextRange(range).select(),this._ranges[0]=range,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,updateAnchorAndFocusFromRange(this,range,!1))},selProto.setRanges=function(ranges){this.removeAllRanges();var rangeCount=ranges.length;rangeCount>1?createControlSelection(this,ranges):rangeCount&&this.addRange(ranges[0])}}selProto.getRangeAt=function(index){if(index<0||index>=this.rangeCount)throw new DOMException("INDEX_SIZE_ERR");return this._ranges[index]};var refreshSelection;if(useDocumentSelection)refreshSelection=function(sel){var range;api.isSelectionValid(sel.win)?range=sel.docSelection.createRange():(range=dom.getBody(sel.win.document).createTextRange(),range.collapse(!0)),sel.docSelection.type==CONTROL?updateControlSelection(sel):isTextRange(range)?updateFromTextRange(sel,range):updateEmptySelection(sel)};else if(util.isHostMethod(testSelection,"getRangeAt")&&typeof testSelection.rangeCount=="number")refreshSelection=function(sel){if(implementsControlRange&&implementsDocSelection&&sel.docSelection.type==CONTROL)updateControlSelection(sel);else{sel._ranges.length=sel.rangeCount=sel.nativeSelection.rangeCount;if(sel.rangeCount){for(var i=0,len=sel.rangeCount;i<len;++i)sel._ranges[i]=new api.WrappedRange(sel.nativeSelection.getRangeAt(i));updateAnchorAndFocusFromRange(sel,sel._ranges[sel.rangeCount-1],selectionIsBackwards(sel.nativeSelection)),sel.isCollapsed=selectionIsCollapsed(sel)}else updateEmptySelection(sel)}};else{if(!selectionHasAnchorAndFocus||typeof testSelection.isCollapsed!=BOOLEAN||typeof testRange.collapsed!=BOOLEAN||!api.features.implementsDomRange)return module.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;refreshSelection=function(sel){var range,nativeSel=sel.nativeSelection;nativeSel.anchorNode?(range=getSelectionRangeAt(nativeSel,0),sel._ranges=[range],sel.rangeCount=1,updateAnchorAndFocusFromNativeSelection(sel),sel.isCollapsed=selectionIsCollapsed(sel)):updateEmptySelection(sel)}}selProto.refresh=function(checkForChanges){var oldRanges=checkForChanges?this._ranges.slice(0):null;refreshSelection(this);if(checkForChanges){var i=oldRanges.length;if(i!=this._ranges.length)return!1;while(i--)if(!DomRange.rangesEqual(oldRanges[i],this._ranges[i]))return!1;return!0}};var removeRangeManually=function(sel,range){var ranges=sel.getAllRanges(),removed=!1;sel.removeAllRanges();for(var i=0,len=ranges.length;i<len;++i)removed||range!==ranges[i]?sel.addRange(ranges[i]):removed=!0;sel.rangeCount||updateEmptySelection(sel)};implementsControlRange?selProto.removeRange=function(range){if(this.docSelection.type==CONTROL){var controlRange=this.docSelection.createRange(),rangeElement=getSingleElementFromRange(range),doc=dom.getDocument(controlRange.item(0)),newControlRange=dom.getBody(doc).createControlRange(),el,removed=!1;for(var i=0,len=controlRange.length;i<len;++i)el=controlRange.item(i),el!==rangeElement||removed?newControlRange.add(controlRange.item(i)):removed=!0;newControlRange.select(),updateControlSelection(this)}else removeRangeManually(this,range)}:selProto.removeRange=function(range){removeRangeManually(this,range)};var selectionIsBackwards;!useDocumentSelection&&selectionHasAnchorAndFocus&&api.features.implementsDomRange?(selectionIsBackwards=function(sel){var backwards=!1;return sel.anchorNode&&(backwards=dom.comparePoints(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset)==1),backwards},selProto.isBackwards=function(){return selectionIsBackwards(this)}):selectionIsBackwards=selProto.isBackwards=function(){return!1},selProto.toString=function(){var rangeTexts=[];for(var i=0,len=this.rangeCount;i<len;++i)rangeTexts[i]=""+this._ranges[i];return rangeTexts.join("")},selProto.collapse=function(node,offset){assertNodeInSameDocument(this,node);var range=api.createRange(dom.getDocument(node));range.collapseToPoint(node,offset),this.removeAllRanges(),this.addRange(range),this.isCollapsed=!0},selProto.collapseToStart=function(){if(!this.rangeCount)throw new DOMException("INVALID_STATE_ERR");var range=this._ranges[0];this.collapse(range.startContainer,range.startOffset)},selProto.collapseToEnd=function(){if(!this.rangeCount)throw new DOMException("INVALID_STATE_ERR");var range=this._ranges[this.rangeCount-1];this.collapse(range.endContainer,range.endOffset)},selProto.selectAllChildren=function(node){assertNodeInSameDocument(this,node);var range=api.createRange(dom.getDocument(node));range.selectNodeContents(node),this.removeAllRanges(),this.addRange(range)},selProto.deleteFromDocument=function(){if(implementsControlRange&&implementsDocSelection&&this.docSelection.type==CONTROL){var controlRange=this.docSelection.createRange(),element;while(controlRange.length)element=controlRange.item(0),controlRange.remove(element),element.parentNode.removeChild(element);this.refresh()}else if(this.rangeCount){var ranges=this.getAllRanges();this.removeAllRanges();for(var i=0,len=ranges.length;i<len;++i)ranges[i].deleteContents();this.addRange(ranges[len-1])}},selProto.getAllRanges=function(){return this._ranges.slice(0)},selProto.setSingleRange=function(range){this.setRanges([range])},selProto.containsNode=function(node,allowPartial){for(var i=0,len=this._ranges.length;i<len;++i)if(this._ranges[i].containsNode(node,allowPartial))return!0;return!1},selProto.toHtml=function(){var html="";if(this.rangeCount){var container=DomRange.getRangeDocument(this._ranges[0]).createElement("div");for(var i=0,len=this._ranges.length;i<len;++i)container.appendChild(this._ranges[i].cloneContents());html=container.innerHTML}return html},selProto.getName=function(){return"WrappedSelection"},selProto.inspect=function(){return inspect(this)},selProto.detach=function(){this.win[windowPropertyName]=null,this.win=this.anchorNode=this.focusNode=null},WrappedSelection.inspect=inspect,api.Selection=WrappedSelection,api.selectionPrototype=selProto,api.addCreateMissingNativeApiListener(function(win){typeof win.getSelection=="undefined"&&(win.getSelection=function(){return api.getSelection(this)}),win=null})});var Base=function(){};Base.extend=function(_instance,_static){var extend=Base.prototype.extend;Base._prototyping=!0;var proto=new this;extend.call(proto,_instance),proto.base=function(){},delete Base._prototyping;var constructor=proto.constructor,klass=proto.constructor=function(){if(!Base._prototyping)if(this._constructing||this.constructor==klass)this._constructing=!0,constructor.apply(this,arguments),delete this._constructing;else if(arguments[0]!=null)return(arguments[0].extend||extend).call(arguments[0],proto)};return klass.ancestor=this,klass.extend=this.extend,klass.forEach=this.forEach,klass.implement=this.implement,klass.prototype=proto,klass.toString=this.toString,klass.valueOf=function(type){return type=="object"?klass:constructor.valueOf()},extend.call(klass,_static),typeof klass.init=="function"&&klass.init(),klass},Base.prototype={extend:function(source,value){if(arguments.length>1){var ancestor=this[source];if(ancestor&&typeof value=="function"&&(!ancestor.valueOf||ancestor.valueOf()!=value.valueOf())&&/\bbase\b/.test(value)){var method=value.valueOf();value=function(){var previous=this.base||Base.prototype.base;this.base=ancestor;var returnValue=method.apply(this,arguments);return this.base=previous,returnValue},value.valueOf=function(type){return type=="object"?value:method},value.toString=Base.toString}this[source]=value}else if(source){var extend=Base.prototype.extend;!Base._prototyping&&typeof this!="function"&&(extend=this.extend||extend);var proto={toSource:null},hidden=["constructor","toString","valueOf"],i=Base._prototyping?0:1;while(key=hidden[i++])source[key]!=proto[key]&&extend.call(this,key,source[key]);for(var key in source)proto[key]||extend.call(this,key,source[key])}return this}},Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(object,block,context){for(var key in object)this.prototype[key]===undefined&&block.call(context,object[key],key,object)},implement:function(){for(var i=0;i<arguments.length;i++)typeof arguments[i]=="function"?arguments[i](this.prototype):this.prototype.extend(arguments[i]);return this},toString:function(){return String(this.valueOf())}}),wysihtml5.browser=function(){function iosVersion(userAgent){return(/ipad|iphone|ipod/.test(userAgent)&&userAgent.match(/ os (\d+).+? like mac os x/)||[,0])[1]}var userAgent=navigator.userAgent,testElement=document.createElement("div"),isIE=userAgent.indexOf("MSIE")!==-1&&userAgent.indexOf("Opera")===-1,isGecko=userAgent.indexOf("Gecko")!==-1&&userAgent.indexOf("KHTML")===-1,isWebKit=userAgent.indexOf("AppleWebKit/")!==-1,isChrome=userAgent.indexOf("Chrome/")!==-1,isOpera=userAgent.indexOf("Opera/")!==-1;return{USER_AGENT:userAgent,supported:function(){var userAgent=this.USER_AGENT.toLowerCase(),hasContentEditableSupport="contentEditable"in testElement,hasEditingApiSupport=document.execCommand&&document.queryCommandSupported&&document.queryCommandState,hasQuerySelectorSupport=document.querySelector&&document.querySelectorAll,isIncompatibleMobileBrowser=this.isIos()&&iosVersion(userAgent)<5||userAgent.indexOf("opera mobi")!==-1||userAgent.indexOf("hpwos/")!==-1;return hasContentEditableSupport&&hasEditingApiSupport&&hasQuerySelectorSupport&&!isIncompatibleMobileBrowser},isTouchDevice:function(){return this.supportsEvent("touchmove")},isIos:function(){var userAgent=this.USER_AGENT.toLowerCase();return userAgent.indexOf("webkit")!==-1&&userAgent.indexOf("mobile")!==-1},supportsSandboxedIframes:function(){return isIE},throwsMixedContentWarningWhenIframeSrcIsEmpty:function(){return!("querySelector"in document)},displaysCaretInEmptyContentEditableCorrectly:function(){return!isGecko},hasCurrentStyleProperty:function(){return"currentStyle"in testElement},insertsLineBreaksOnReturn:function(){return isGecko},supportsPlaceholderAttributeOn:function(element){return"placeholder"in element},supportsEvent:function(eventName){return"on"+eventName in testElement||function(){return testElement.setAttribute("on"+eventName,"return;"),typeof testElement["on"+eventName]=="function"}()},supportsEventsInIframeCorrectly:function(){return!isOpera},firesOnDropOnlyWhenOnDragOverIsCancelled:function(){return isWebKit||isGecko},supportsDataTransfer:function(){try{return isWebKit&&(window.Clipboard||window.DataTransfer).prototype.getData}catch(e){return!1}},supportsHTML5Tags:function(context){var element=context.createElement("div"),html5="<article>foo</article>";return element.innerHTML=html5,element.innerHTML.toLowerCase()===html5},supportsCommand:function(){var buggyCommands={formatBlock:isIE,insertUnorderedList:isIE||isOpera,insertOrderedList:isIE||isOpera},supported={insertHTML:isGecko};return function(doc,command){var isBuggy=buggyCommands[command];if(!isBuggy){try{return doc.queryCommandSupported(command)}catch(e1){}try{return doc.queryCommandEnabled(command)}catch(e2){return!!supported[command]}}return!1}}(),doesAutoLinkingInContentEditable:function(){return isIE},canDisableAutoLinking:function(){return this.supportsCommand(document,"AutoUrlDetect")},clearsContentEditableCorrectly:function(){return isGecko||isOpera||isWebKit},supportsGetAttributeCorrectly:function(){var td=document.createElement("td");return td.getAttribute("rowspan")!="1"},canSelectImagesInContentEditable:function(){return isGecko||isIE||isOpera},clearsListsInContentEditableCorrectly:function(){return isGecko||isIE||isWebKit},autoScrollsToCaret:function(){return!isWebKit},autoClosesUnclosedTags:function(){var clonedTestElement=testElement.cloneNode(!1),returnValue,innerHTML;return clonedTestElement.innerHTML="<p><div></div>",innerHTML=clonedTestElement.innerHTML.toLowerCase(),returnValue=innerHTML==="<p></p><div></div>"||innerHTML==="<p><div></div></p>",this.autoClosesUnclosedTags=function(){return returnValue},returnValue},supportsNativeGetElementsByClassName:function(){return String(document.getElementsByClassName).indexOf("[native code]")!==-1},supportsSelectionModify:function(){return"getSelection"in window&&"modify"in window.getSelection()},supportsClassList:function(){return"classList"in testElement},needsSpaceAfterLineBreak:function(){return isOpera},supportsSpeechApiOn:function(input){var chromeVersion=userAgent.match(/Chrome\/(\d+)/)||[,0];return chromeVersion[1]>=11&&("onwebkitspeechchange"in input||"speech"in input)},crashesWhenDefineProperty:function(property){return isIE&&(property==="XMLHttpRequest"||property==="XDomainRequest")},doesAsyncFocus:function(){return isIE},hasProblemsSettingCaretAfterImg:function(){return isIE},hasUndoInContextMenu:function(){return isGecko||isChrome||isOpera}}}(),wysihtml5.lang.array=function(arr){return{contains:function(needle){if(arr.indexOf)return arr.indexOf(needle)!==-1;for(var i=0,length=arr.length;i<length;i++)if(arr[i]===needle)return!0;return!1},without:function(arrayToSubstract){arrayToSubstract=wysihtml5.lang.array(arrayToSubstract);var newArr=[],i=0,length=arr.length;for(;i<length;i++)arrayToSubstract.contains(arr[i])||newArr.push(arr[i]);return newArr},get:function(){var i=0,length=arr.length,newArray=[];for(;i<length;i++)newArray.push(arr[i]);return newArray}}},wysihtml5.lang.Dispatcher=Base.extend({observe:function(eventName,handler){return this.events=this.events||{},this.events[eventName]=this.events[eventName]||[],this.events[eventName].push(handler),this},on:function(){return this.observe.apply(this,wysihtml5.lang.array(arguments).get())},fire:function(eventName,payload){this.events=this.events||{};var handlers=this.events[eventName]||[],i=0;for(;i<handlers.length;i++)handlers[i].call(this,payload);return this},stopObserving:function(eventName,handler){this.events=this.events||{};var i=0,handlers,newHandlers;if(eventName){handlers=this.events[eventName]||[],newHandlers=[];for(;i<handlers.length;i++)handlers[i]!==handler&&handler&&newHandlers.push(handlers[i]);this.events[eventName]=newHandlers}else this.events={};return this}}),wysihtml5.lang.object=function(obj){return{merge:function(otherObj){for(var i in otherObj)obj[i]=otherObj[i];return this},get:function(){return obj},clone:function(){var newObj={},i;for(i in obj)newObj[i]=obj[i];return newObj},isArray:function(){return Object.prototype.toString.call(obj)==="[object Array]"}}},function(){var WHITE_SPACE_START=/^\s+/,WHITE_SPACE_END=/\s+$/;wysihtml5.lang.string=function(str){return str=String(str),{trim:function(){return str.replace(WHITE_SPACE_START,"").replace(WHITE_SPACE_END,"")},interpolate:function(vars){for(var i in vars)str=this.replace("#{"+i+"}").by(vars[i]);return str},replace:function(search){return{by:function(replace){return str.split(search).join(replace)}}}}}}(),function(wysihtml5){function autoLink(element){return _hasParentThatShouldBeIgnored(element)?element:(element===element.ownerDocument.documentElement&&(element=element.ownerDocument.body),_parseNode(element))}function _convertUrlsToLinks(str){return str.replace(URL_REG_EXP,function(match,url){var videoid,imgid,punctuation=(url.match(TRAILING_CHAR_REG_EXP)||[])[1]||"",opening=BRACKETS[punctuation];url=url.replace(TRAILING_CHAR_REG_EXP,""),url.split(opening).length>url.split(punctuation).length&&(url+=punctuation,punctuation="");var realUrl=url,displayUrl=url;return url.length>MAX_DISPLAY_LENGTH&&(displayUrl=displayUrl.substr(0,MAX_DISPLAY_LENGTH)+"..."),realUrl.substr(0,4)==="www."&&(realUrl="http://"+realUrl),displayUrl.match(/(\.jpg|\.gif|\.png)$/)?'<img src="'+displayUrl+'" alt="">':(videoid=displayUrl.match(/youtube\.com\/watch\?v\=([a-zA-Z0-9-]+)/)||displayUrl.match(/youtu\.be\/([a-zA-Z0-9-]+)/))?(videoid=videoid[1],'<iframe width="420" height="315" src="http://www.youtube.com/embed/'+videoid+'" frameborder="0" allowfullscreen></'+"iframe>"):'<a href="'+realUrl+'">'+displayUrl+"</a>"+punctuation})}function _getTempElement(context){var tempElement=context._wysihtml5_tempElement;return tempElement||(tempElement=context._wysihtml5_tempElement=context.createElement("div")),tempElement}function _wrapMatchesInNode(textNode){var parentNode=textNode.parentNode,tempElement=_getTempElement(parentNode.ownerDocument);tempElement.innerHTML="<span></span>"+_convertUrlsToLinks(textNode.data),tempElement.removeChild(tempElement.firstChild);while(tempElement.firstChild)parentNode.insertBefore(tempElement.firstChild,textNode);parentNode.removeChild(textNode)}function _hasParentThatShouldBeIgnored(node){var nodeName;while(node.parentNode){node=node.parentNode,nodeName=node.nodeName;if(IGNORE_URLS_IN.contains(nodeName))return!0;if(nodeName==="body")return!1}return!1}function _parseNode(element){if(IGNORE_URLS_IN.contains(element.nodeName))return;if(element.nodeType===wysihtml5.TEXT_NODE&&element.data.match(URL_REG_EXP)){_wrapMatchesInNode(element);return}var childNodes=wysihtml5.lang.array(element.childNodes).get(),childNodesLength=childNodes.length,i=0;for(;i<childNodesLength;i++)_parseNode(childNodes[i]);return element}var IGNORE_URLS_IN=wysihtml5.lang.array(["CODE","PRE","A","SCRIPT","HEAD","TITLE","STYLE"]),URL_REG_EXP=/((https?:\/\/|www\.)[^\s<]{3,})/gi,TRAILING_CHAR_REG_EXP=/([^\w\/\-](,?))$/i,MAX_DISPLAY_LENGTH=100,BRACKETS={")":"(","]":"[","}":"{"};wysihtml5.dom.autoLink=autoLink,wysihtml5.dom.autoLink.URL_REG_EXP=URL_REG_EXP}(wysihtml5),function(wysihtml5){var supportsClassList=wysihtml5.browser.supportsClassList(),api=wysihtml5.dom;api.addClass=function(element,className){if(supportsClassList)return element.classList.add(className);if(api.hasClass(element,className))return;element.className+=" "+className},api.removeClass=function(element,className){if(supportsClassList)return element.classList.remove(className);element.className=element.className.replace(new RegExp("(^|\\s+)"+className+"(\\s+|$)")," ")},api.hasClass=function(element,className){if(supportsClassList)return element.classList.contains(className);var elementClassName=element.className;return elementClassName.length>0&&(elementClassName==className||(new RegExp("(^|\\s)"+className+"(\\s|$)")).test(elementClassName))}}(wysihtml5),wysihtml5.dom.contains=function(){var documentElement=document.documentElement;if(documentElement.contains)return function(container,element){return element.nodeType!==wysihtml5.ELEMENT_NODE&&(element=element.parentNode),container!==element&&container.contains(element)};if(documentElement.compareDocumentPosition)return function(container,element){return!!(container.compareDocumentPosition(element)&16)}}(),wysihtml5.dom.convertToList=function(){function _createListItem(doc,list){var listItem=doc.createElement("li");return list.appendChild(listItem),listItem}function _createList(doc,type){return doc.createElement(type)}function convertToList(element,listType){if(element.nodeName==="UL"||element.nodeName==="OL"||element.nodeName==="MENU")return element;var doc=element.ownerDocument,list=_createList(doc,listType),childNodes=wysihtml5.lang.array(element.childNodes).get(),childNodesLength=childNodes.length,childNode,isBlockElement,isLineBreak,currentListItem,i=0;for(;i<childNodesLength;i++){currentListItem=currentListItem||_createListItem(doc,list),childNode=childNodes[i],isBlockElement=wysihtml5.dom.getStyle("display").from(childNode)==="block",isLineBreak=childNode.nodeName==="BR";if(isBlockElement){currentListItem=currentListItem.firstChild?_createListItem(doc,list):currentListItem,currentListItem.appendChild(childNode),currentListItem=null;continue}if(isLineBreak){currentListItem=currentListItem.firstChild?null:currentListItem;continue}currentListItem.appendChild(childNode)}return element.parentNode.replaceChild(list,element),list}return convertToList}(),wysihtml5.dom.copyAttributes=function(attributesToCopy){return{from:function(elementToCopyFrom){return{to:function(elementToCopyTo){var attribute,i=0,length=attributesToCopy.length;for(;i<length;i++)attribute=attributesToCopy[i],elementToCopyFrom[attribute]&&(elementToCopyTo[attribute]=elementToCopyFrom[attribute]);return{andTo:arguments.callee}}}}}},function(dom){var BOX_SIZING_PROPERTIES=["-webkit-box-sizing","-moz-box-sizing","-ms-box-sizing","box-sizing"],shouldIgnoreBoxSizingBorderBox=function(element){return hasBoxSizingBorderBox(element)?parseInt(dom.getStyle("width").from(element),10)<element.offsetWidth:!1},hasBoxSizingBorderBox=function(element){var i=0,length=BOX_SIZING_PROPERTIES.length;for(;i<length;i++)if(dom.getStyle(BOX_SIZING_PROPERTIES[i]).from(element)==="border-box")return BOX_SIZING_PROPERTIES[i]};dom.copyStyles=function(stylesToCopy){return{from:function(element){shouldIgnoreBoxSizingBorderBox(element)&&(stylesToCopy=wysihtml5.lang.array(stylesToCopy).without(BOX_SIZING_PROPERTIES));var cssText="",length=stylesToCopy.length,i=0,property;for(;i<length;i++)property=stylesToCopy[i],cssText+=property+":"+dom.getStyle(property).from(element)+";";return{to:function(element){return dom.setStyles(cssText).on(element),{andTo:arguments.callee}}}}}}}(wysihtml5.dom),function(wysihtml5){wysihtml5.dom.delegate=function(container,selector,eventName,handler){return wysihtml5.dom.observe(container,eventName,function(event){var target=event.target,match=wysihtml5.lang.array(container.querySelectorAll(selector));while(target&&target!==container){if(match.contains(target)){handler.call(target,event);break}target=target.parentNode}})}}(wysihtml5),wysihtml5.dom.getAsDom=function(){var _innerHTMLShiv=function(html,context){var tempElement=context.createElement("div");tempElement.style.display="none",context.body.appendChild(tempElement);try{tempElement.innerHTML=html}catch(e){}return context.body.removeChild(tempElement),tempElement},_ensureHTML5Compatibility=function(context){if(context._wysihtml5_supportsHTML5Tags)return;for(var i=0,length=HTML5_ELEMENTS.length;i<length;i++)context.createElement(HTML5_ELEMENTS[i]);context._wysihtml5_supportsHTML5Tags=!0},HTML5_ELEMENTS=["abbr","article","aside","audio","bdi","canvas","command","datalist","details","figcaption","figure","footer","header","hgroup","keygen","mark","meter","nav","output","progress","rp","rt","ruby","svg","section","source","summary","time","track","video","wbr"];return function(html,context){context=context||document;var tempElement;return typeof html=="object"&&html.nodeType?(tempElement=context.createElement("p"),tempElement.appendChild(html)):wysihtml5.browser.supportsHTML5Tags(context)?(tempElement=context.createElement("p"),tempElement.innerHTML=html):(_ensureHTML5Compatibility(context),tempElement=_innerHTMLShiv(html,context)),tempElement}}(),wysihtml5.dom.getParentElement=function(){function _isSameNodeName(nodeName,desiredNodeNames){return!desiredNodeNames||!desiredNodeNames.length?!0:typeof desiredNodeNames=="string"?nodeName===desiredNodeNames:wysihtml5.lang.array(desiredNodeNames).contains(nodeName)}function _isElement(node){return node.nodeType===wysihtml5.ELEMENT_NODE}function _hasClassName(element,className,classRegExp){var classNames=(element.className||"").match(classRegExp)||[];return className?classNames[classNames.length-1]===className:!!classNames.length}function _getParentElementWithNodeName(node,nodeName,levels){while(levels--&&node&&node.nodeName!=="BODY"){if(_isSameNodeName(node.nodeName,nodeName))return node;node=node.parentNode}return null}function _getParentElementWithNodeNameAndClassName(node,nodeName,className,classRegExp,levels){while(levels--&&node&&node.nodeName!=="BODY"){if(_isElement(node)&&_isSameNodeName(node.nodeName,nodeName)&&_hasClassName(node,className,classRegExp))return node;node=node.parentNode}return null}return function(node,matchingSet,levels){return levels=levels||50,matchingSet.className||matchingSet.classRegExp?_getParentElementWithNodeNameAndClassName(node,matchingSet.nodeName,matchingSet.className,matchingSet.classRegExp,levels):_getParentElementWithNodeName(node,matchingSet.nodeName,levels)}}(),wysihtml5.dom.getStyle=function(){function camelize(str){return str.replace(REG_EXP_CAMELIZE,function(match){return match.charAt(1).toUpperCase()})}var stylePropertyMapping={"float":"styleFloat"in document.createElement("div").style?"styleFloat":"cssFloat"},REG_EXP_CAMELIZE=/\-[a-z]/g;return function(property){return{from:function(element){if(element.nodeType!==wysihtml5.ELEMENT_NODE)return;var doc=element.ownerDocument,camelizedProperty=stylePropertyMapping[property]||camelize(property),style=element.style,currentStyle=element.currentStyle,styleValue=style[camelizedProperty];if(styleValue)return styleValue;if(currentStyle)try{return currentStyle[camelizedProperty]}catch(e){}var win=doc.defaultView||doc.parentWindow,needsOverflowReset=(property==="height"||property==="width")&&element.nodeName==="TEXTAREA",originalOverflow,returnValue;if(win.getComputedStyle)return needsOverflowReset&&(originalOverflow=style.overflow,style.overflow="hidden"),returnValue=win.getComputedStyle(element,null).getPropertyValue(property),needsOverflowReset&&(style.overflow=originalOverflow||""),returnValue}}}}(),wysihtml5.dom.hasElementWithTagName=function(){function _getDocumentIdentifier(doc){return doc._wysihtml5_identifier||(doc._wysihtml5_identifier=DOCUMENT_IDENTIFIER++)}var LIVE_CACHE={},DOCUMENT_IDENTIFIER=1;return function(doc,tagName){var key=_getDocumentIdentifier(doc)+":"+tagName,cacheEntry=LIVE_CACHE[key];return cacheEntry||(cacheEntry=LIVE_CACHE[key]=doc.getElementsByTagName(tagName)),cacheEntry.length>0}}(),function(wysihtml5){function _getDocumentIdentifier(doc){return doc._wysihtml5_identifier||(doc._wysihtml5_identifier=DOCUMENT_IDENTIFIER++)}var LIVE_CACHE={},DOCUMENT_IDENTIFIER=1;wysihtml5.dom.hasElementWithClassName=function(doc,className){if(!wysihtml5.browser.supportsNativeGetElementsByClassName())return!!doc.querySelector("."+className);var key=_getDocumentIdentifier(doc)+":"+className,cacheEntry=LIVE_CACHE[key];return cacheEntry||(cacheEntry=LIVE_CACHE[key]=doc.getElementsByClassName(className)),cacheEntry.length>0}}(wysihtml5),wysihtml5.dom.insert=function(elementToInsert){return{after:function(element){element.parentNode.insertBefore(elementToInsert,element.nextSibling)},before:function(element){element.parentNode.insertBefore(elementToInsert,element)},into:function(element){element.appendChild(elementToInsert)}}},wysihtml5.dom.insertCSS=function(rules){return rules=rules.join("\n"),{into:function(doc){var head=doc.head||doc.getElementsByTagName("head")[0],styleElement=doc.createElement("style");styleElement.type="text/css",styleElement.styleSheet?styleElement.styleSheet.cssText=rules:styleElement.appendChild(doc.createTextNode(rules)),head&&head.appendChild(styleElement)}}},wysihtml5.dom.observe=function(element,eventNames,handler){eventNames=typeof eventNames=="string"?[eventNames]:eventNames;var handlerWrapper,eventName,i=0,length=eventNames.length;for(;i<length;i++)eventName=eventNames[i],element.addEventListener?element.addEventListener(eventName,handler,!1):(handlerWrapper=function(event){"target"in event||(event.target=event.srcElement),event.preventDefault=event.preventDefault||function(){this.returnValue=!1},event.stopPropagation=event.stopPropagation||function(){this.cancelBubble=!0},handler.call(element,event)},element.attachEvent("on"+eventName,handlerWrapper));return{stop:function(){var eventName,i=0,length=eventNames.length;for(;i<length;i++)eventName=eventNames[i],element.removeEventListener?element.removeEventListener(eventName,handler,!1):element.detachEvent("on"+eventName,handlerWrapper)}}},wysihtml5.dom.parse=function(){function parse(elementOrHtml,rules,context,cleanUp){wysihtml5.lang.object(currentRules).merge(defaultRules).merge(rules).get(),context=context||elementOrHtml.ownerDocument||document;var fragment=context.createDocumentFragment(),isString=typeof elementOrHtml=="string",element,newNode,firstChild;isString?element=wysihtml5.dom.getAsDom(elementOrHtml,context):element=elementOrHtml;while(element.firstChild)firstChild=element.firstChild,element.removeChild(firstChild),newNode=_convert(firstChild,cleanUp),newNode&&fragment.appendChild(newNode);return element.innerHTML="",element.appendChild(fragment),isString?wysihtml5.quirks.getCorrectInnerHTML(element):element}function _convert(oldNode,cleanUp){var oldNodeType=oldNode.nodeType,oldChilds=oldNode.childNodes,oldChildsLength=oldChilds.length,newNode,method=NODE_TYPE_MAPPING[oldNodeType],i=0;newNode=method&&method(oldNode);if(!newNode)return null;for(i=0;i<oldChildsLength;i++)newChild=_convert(oldChilds[i],cleanUp),newChild&&newNode.appendChild(newChild);return cleanUp&&newNode.childNodes.length<=1&&newNode.nodeName.toLowerCase()===DEFAULT_NODE_NAME&&!newNode.attributes.length?newNode.firstChild:newNode}function _handleElement(oldNode){var rule,newNode,endTag,tagRules=currentRules.tags,nodeName=oldNode.nodeName.toLowerCase(),scopeName=oldNode.scopeName;if(oldNode._wysihtml5)return null;oldNode._wysihtml5=1;if(oldNode.className==="wysihtml5-temp")return null;scopeName&&scopeName!="HTML"&&(nodeName=scopeName+":"+nodeName),"outerHTML"in oldNode&&!wysihtml5.browser.autoClosesUnclosedTags()&&oldNode.nodeName==="P"&&oldNode.outerHTML.slice(-4).toLowerCase()!=="</p>"&&(nodeName="div");if(nodeName in tagRules){rule=tagRules[nodeName];if(!rule||rule.remove)return null;rule=typeof rule=="string"?{rename_tag:rule}:rule}else{if(!oldNode.firstChild)return null;rule={rename_tag:DEFAULT_NODE_NAME}}return newNode=oldNode.ownerDocument.createElement(rule.rename_tag||nodeName),_handleAttributes(oldNode,newNode,rule),oldNode=null,newNode}function _handleAttributes(oldNode,newNode,rule){var attributes={},setClass=rule.set_class,addClass=rule.add_class,setAttributes=rule.set_attributes,checkAttributes=rule.check_attributes,allowedClasses=currentRules.classes,i=0,classes=[],newClasses=[],newUniqueClasses=[],oldClasses=[],classesLength,newClassesLength,currentClass,newClass,attributeName,newAttributeValue,method;setAttributes&&(attributes=wysihtml5.lang.object(setAttributes).clone());if(checkAttributes)for(attributeName in checkAttributes){method=attributeCheckMethods[checkAttributes[attributeName]];if(!method)continue;newAttributeValue=method(_getAttribute(oldNode,attributeName)),typeof newAttributeValue=="string"&&(attributes[attributeName]=newAttributeValue)}setClass&&classes.push(setClass);if(addClass)for(attributeName in addClass){method=addClassMethods[addClass[attributeName]];if(!method)continue;newClass=method(_getAttribute(oldNode,attributeName)),typeof newClass=="string"&&classes.push(newClass)}allowedClasses["_wysihtml5-temp-placeholder"]=1,oldClasses=oldNode.getAttribute("class"),oldClasses&&(classes=classes.concat(oldClasses.split(WHITE_SPACE_REG_EXP))),classesLength=classes.length;for(;i<classesLength;i++)currentClass=classes[i],allowedClasses[currentClass]&&newClasses.push(currentClass);newClassesLength=newClasses.length;while(newClassesLength--)currentClass=newClasses[newClassesLength],wysihtml5.lang.array(newUniqueClasses).contains(currentClass)||newUniqueClasses.unshift(currentClass);newUniqueClasses.length&&(attributes["class"]=newUniqueClasses.join(" "));for(attributeName in attributes)try{newNode.setAttribute(attributeName,attributes[attributeName])}catch(e){}attributes.src&&(typeof attributes.width!="undefined"&&newNode.setAttribute("width",attributes.width),typeof attributes.height!="undefined"&&newNode.setAttribute("height",attributes.height))}function _getAttribute(node,attributeName){attributeName=attributeName.toLowerCase();var nodeName=node.nodeName;if(nodeName=="IMG"&&attributeName=="src"&&_isLoadedImage(node)===!0)return node.src;if(HAS_GET_ATTRIBUTE_BUG&&"outerHTML"in node){var outerHTML=node.outerHTML.toLowerCase(),hasAttribute=outerHTML.indexOf(" "+attributeName+"=")!=-1;return hasAttribute?node.getAttribute(attributeName):null}return node.getAttribute(attributeName)}function _isLoadedImage(node){try{return node.complete&&!node.mozMatchesSelector(":-moz-broken")}catch(e){if(node.complete&&node.readyState==="complete")return!0}}function _handleText(oldNode){return oldNode.ownerDocument.createTextNode(oldNode.data)}var NODE_TYPE_MAPPING={1:_handleElement,3:_handleText},DEFAULT_NODE_NAME="span",WHITE_SPACE_REG_EXP=/\s+/,defaultRules={tags:{},classes:{}},currentRules={},HAS_GET_ATTRIBUTE_BUG=!wysihtml5.browser.supportsGetAttributeCorrectly(),attributeCheckMethods={url:function(){var REG_EXP=/^https?:\/\//i;return function(attributeValue){return!attributeValue||!attributeValue.match(REG_EXP)?null:attributeValue.replace(REG_EXP,function(match){return match.toLowerCase()})}}(),alt:function(){var REG_EXP=/[^ a-z0-9_\-]/gi;return function(attributeValue){return attributeValue?attributeValue.replace(REG_EXP,""):""}}(),numbers:function(){var REG_EXP=/\D/g;return function(attributeValue){return attributeValue=(attributeValue||"").replace(REG_EXP,""),attributeValue||null}}()},addClassMethods={align_img:function(){var mapping={left:"wysiwyg-float-left",right:"wysiwyg-float-right"};return function(attributeValue){return mapping[String(attributeValue).toLowerCase()]}}(),align_text:function(){var mapping={left:"wysiwyg-text-align-left",right:"wysiwyg-text-align-right",center:"wysiwyg-text-align-center",justify:"wysiwyg-text-align-justify"};return function(attributeValue){return mapping[String(attributeValue).toLowerCase()]}}(),clear_br:function(){var mapping={left:"wysiwyg-clear-left",right:"wysiwyg-clear-right",both:"wysiwyg-clear-both",all:"wysiwyg-clear-both"};return function(attributeValue){return mapping[String(attributeValue).toLowerCase()]}}(),size_font:function(){var mapping={1:"wysiwyg-font-size-xx-small",2:"wysiwyg-font-size-small",3:"wysiwyg-font-size-medium",4:"wysiwyg-font-size-large",5:"wysiwyg-font-size-x-large",6:"wysiwyg-font-size-xx-large",7:"wysiwyg-font-size-xx-large","-":"wysiwyg-font-size-smaller","+":"wysiwyg-font-size-larger"};return function(attributeValue){return mapping[String(attributeValue).charAt(0)]}}()};return parse}(),wysihtml5.dom.removeEmptyTextNodes=function(node){var childNode,childNodes=wysihtml5.lang.array(node.childNodes).get(),childNodesLength=childNodes.length,i=0;for(;i<childNodesLength;i++)childNode=childNodes[i],childNode.nodeType===wysihtml5.TEXT_NODE&&childNode.data===""&&childNode.parentNode.removeChild(childNode)},wysihtml5.dom.renameElement=function(element,newNodeName){var newElement=element.ownerDocument.createElement(newNodeName),firstChild;while(firstChild=element.firstChild)newElement.appendChild(firstChild);return wysihtml5.dom.copyAttributes(["align","className"]).from(element).to(newElement),element.parentNode.replaceChild(newElement,element),newElement},wysihtml5.dom.replaceWithChildNodes=function(node){if(!node.parentNode)return;if(!node.firstChild){node.parentNode.removeChild(node);return}var fragment=node.ownerDocument.createDocumentFragment();while(node.firstChild)fragment.appendChild(node.firstChild);node.parentNode.replaceChild(fragment,node),node=fragment=null},function(dom){function _isBlockElement(node){return dom.getStyle("display").from(node)==="block"}function _isLineBreak(node){return node.nodeName==="BR"}function _appendLineBreak(element){var lineBreak=element.ownerDocument.createElement("br");element.appendChild(lineBreak)}function resolveList(list){if(list.nodeName!=="MENU"&&list.nodeName!=="UL"&&list.nodeName!=="OL")return;var doc=list.ownerDocument,fragment=doc.createDocumentFragment(),previousSibling=list.previousSibling,firstChild,lastChild,isLastChild,shouldAppendLineBreak,listItem;previousSibling&&!_isBlockElement(previousSibling)&&_appendLineBreak(fragment);while(listItem=list.firstChild){lastChild=listItem.lastChild;while(firstChild=listItem.firstChild)isLastChild=firstChild===lastChild,shouldAppendLineBreak=isLastChild&&!_isBlockElement(firstChild)&&!_isLineBreak(firstChild),fragment.appendChild(firstChild),shouldAppendLineBreak&&_appendLineBreak(fragment);listItem.parentNode.removeChild(listItem)}list.parentNode.replaceChild(fragment,list)}dom.resolveList=resolveList}(wysihtml5.dom),function(wysihtml5){var doc=document,windowProperties=["parent","top","opener","frameElement","frames","localStorage","globalStorage","sessionStorage","indexedDB"],windowProperties2=["open","close","openDialog","showModalDialog","alert","confirm","prompt","openDatabase","postMessage","XMLHttpRequest","XDomainRequest"],documentProperties=["referrer","write","open","close"];wysihtml5.dom.Sandbox=Base.extend({constructor:function(readyCallback,config){this.callback=readyCallback||wysihtml5.EMPTY_FUNCTION,this.config=wysihtml5.lang.object({}).merge(config).get(),this.iframe=this._createIframe()},insertInto:function(element){typeof element=="string"&&(element=doc.getElementById(element)),element.appendChild(this.iframe)},getIframe:function(){return this.iframe},getWindow:function(){this._readyError()},getDocument:function(){this._readyError()},destroy:function(){var iframe=this.getIframe();iframe.parentNode.removeChild(iframe)},_readyError:function(){throw new Error("wysihtml5.Sandbox: Sandbox iframe isn't loaded yet")},_createIframe:function(){var that=this,iframe=doc.createElement("iframe");return iframe.className="wysihtml5-sandbox",wysihtml5.dom.setAttributes({security:"restricted",allowtransparency:"true",frameborder:0,marginwidth:0,marginheight:0}).on(iframe),wysihtml5.browser.throwsMixedContentWarningWhenIframeSrcIsEmpty()&&(iframe.src="javascript:'<html></html>'"),iframe.onload=function(){iframe.onreadystatechange=iframe.onload=null,that._onLoadIframe(iframe)},iframe.onreadystatechange=function(){/loaded|complete/.test(iframe.readyState)&&(iframe.onreadystatechange=iframe.onload=null,that._onLoadIframe(iframe))},iframe},_onLoadIframe:function(iframe){if(!wysihtml5.dom.contains(doc.documentElement,iframe))return;var that=this,iframeWindow=iframe.contentWindow,iframeDocument=iframe.contentWindow.document,charset=doc.characterSet||doc.charset||"utf-8",sandboxHtml=this._getHtml({charset:charset,stylesheets:this.config.stylesheets});iframeDocument.open("text/html","replace"),iframeDocument.write(sandboxHtml),iframeDocument.close(),this.getWindow=function(){return iframe.contentWindow},this.getDocument=function(){return iframe.contentWindow.document},iframeWindow.onerror=function(errorMessage,fileName,lineNumber){throw new Error("wysihtml5.Sandbox: "+errorMessage,fileName,lineNumber)};if(!wysihtml5.browser.supportsSandboxedIframes()){var i,length;for(i=0,length=windowProperties.length;i<length;i++)this._unset(iframeWindow,windowProperties[i]);for(i=0,length=windowProperties2.length;i<length;i++)this._unset(iframeWindow,windowProperties2[i],wysihtml5.EMPTY_FUNCTION);for(i=0,length=documentProperties.length;i<length;i++)this._unset(iframeDocument,documentProperties[i]);this._unset(iframeDocument,"cookie","",!0)}this.loaded=!0,setTimeout(function(){that.callback(that)},0)},_getHtml:function(templateVars){var stylesheets=templateVars.stylesheets,html="",i=0,length;stylesheets=typeof stylesheets=="string"?[stylesheets]:stylesheets;if(stylesheets){length=stylesheets.length;for(;i<length;i++)html+='<link rel="stylesheet" href="'+stylesheets[i]+'">'}return templateVars.stylesheets=html,wysihtml5.lang.string('<!DOCTYPE html><html><head><meta charset="#{charset}">#{stylesheets}</head><body></body></html>').interpolate(templateVars)},_unset:function(object,property,value,setter){try{object[property]=value}catch(e){}try{object.__defineGetter__(property,function(){return value})}catch(e){}if(setter)try{object.__defineSetter__(property,function(){})}catch(e){}if(!wysihtml5.browser.crashesWhenDefineProperty(property))try{var config={get:function(){return value}};setter&&(config.set=function(){}),Object.defineProperty(object,property,config)}catch(e){}}})}(wysihtml5),function(){var mapping={className:"class"};wysihtml5.dom.setAttributes=function(attributes){return{on:function(element){for(var i in attributes)element.setAttribute(mapping[i]||i,attributes[i])}}}}(),wysihtml5.dom.setStyles=function(styles){return{on:function(element){var style=element.style;if(typeof styles=="string"){style.cssText+=";"+styles;return}for(var i in styles)i==="float"?(style.cssFloat=styles[i],style.styleFloat=styles[i]):style[i]=styles[i]}}},function(dom){var documentElement=document.documentElement;"textContent"in documentElement?(dom.setTextContent=function(element,text){element.textContent=text},dom.getTextContent=function(element){return element.textContent}):"innerText"in documentElement?(dom.setTextContent=function(element,text){element.innerText=text},dom.getTextContent=function(element){return element.innerText}):(dom.setTextContent=function(element,text){element.nodeValue=text},dom.getTextContent=function(element){return element.nodeValue})}(wysihtml5.dom),wysihtml5.quirks.cleanPastedHTML=function(){function cleanPastedHTML(elementOrHtml,rules,context){rules=rules||defaultRules,context=context||elementOrHtml.ownerDocument||document;var element,isString=typeof elementOrHtml=="string",method,matches,matchesLength,i,j=0;isString?element=wysihtml5.dom.getAsDom(elementOrHtml,context):element=elementOrHtml;for(i in rules){matches=element.querySelectorAll(i),method=rules[i],matchesLength=matches.length;for(;j<matchesLength;j++)method(matches[j])}return matches=elementOrHtml=rules=null,isString?element.innerHTML:element}var defaultRules={"a u":wysihtml5.dom.replaceWithChildNodes};return cleanPastedHTML}(),function(wysihtml5){var dom=wysihtml5.dom;wysihtml5.quirks.ensureProperClearing=function(){var clearIfNecessary=function(event){var element=this;setTimeout(function(){var innerHTML=element.innerHTML.toLowerCase();if(innerHTML=="<p>&nbsp;</p>"||innerHTML=="<p>&nbsp;</p><p>&nbsp;</p>")element.innerHTML=""},0)};return function(composer){dom.observe(composer.element,["cut","keydown"],clearIfNecessary)}}(),wysihtml5.quirks.ensureProperClearingOfLists=function(){var ELEMENTS_THAT_CONTAIN_LI=["OL","UL","MENU"],clearIfNecessary=function(element,contentEditableElement){if(!contentEditableElement.firstChild||!wysihtml5.lang.array(ELEMENTS_THAT_CONTAIN_LI).contains(contentEditableElement.firstChild.nodeName))return;var list=dom.getParentElement(element,{nodeName:ELEMENTS_THAT_CONTAIN_LI});if(!list)return;var listIsFirstChildOfContentEditable=list==contentEditableElement.firstChild;if(!listIsFirstChildOfContentEditable)return;var hasOnlyOneListItem=list.childNodes.length<=1;if(!hasOnlyOneListItem)return;var onlyListItemIsEmpty=list.firstChild?list.firstChild.innerHTML==="":!0;if(!onlyListItemIsEmpty)return;list.parentNode.removeChild(list)};return function(composer){dom.observe(composer.element,"keydown",function(event){if(event.keyCode!==wysihtml5.BACKSPACE_KEY)return;var element=composer.selection.getSelectedNode();clearIfNecessary(element,composer.element)})}}()}(wysihtml5),function(wysihtml5){var TILDE_ESCAPED="%7E";wysihtml5.quirks.getCorrectInnerHTML=function(element){var innerHTML=element.innerHTML;if(innerHTML.indexOf(TILDE_ESCAPED)===-1)return innerHTML;var elementsWithTilde=element.querySelectorAll("[href*='~'], [src*='~']"),url,urlToSearch,length,i;for(i=0,length=elementsWithTilde.length;i<length;i++)url=elementsWithTilde[i].href||elementsWithTilde[i].src,urlToSearch=wysihtml5.lang.string(url).replace("~").by(TILDE_ESCAPED),innerHTML=wysihtml5.lang.string(innerHTML).replace(urlToSearch).by(url);return innerHTML}}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,USE_NATIVE_LINE_BREAK_WHEN_CARET_INSIDE_TAGS=["LI","P","H1","H2","H3","H4","H5","H6"],LIST_TAGS=["UL","OL","MENU"];wysihtml5.quirks.insertLineBreakOnReturn=function(composer){function unwrap(selectedNode){var parentElement=dom.getParentElement(selectedNode,{nodeName:["P","DIV"]},2);if(!parentElement)return;var invisibleSpace=document.createTextNode(wysihtml5.INVISIBLE_SPACE);dom.insert(invisibleSpace).before(parentElement),dom.replaceWithChildNodes(parentElement),composer.selection.selectNode(invisibleSpace)}function keyDown(event){var keyCode=event.keyCode,element=event.target,selectedNode=composer.selection.getSelectedNode(),blockElement=dom.getParentElement(selectedNode,{nodeName:USE_NATIVE_LINE_BREAK_WHEN_CARET_INSIDE_TAGS},4);if(blockElement){blockElement.nodeName==="LI"&&keyCode===9&&(event.preventDefault(),event.shiftKey?composer.commands.exec("outdent"):composer.commands.exec("indent")),blockElement.nodeName!=="LI"||keyCode!==wysihtml5.ENTER_KEY&&keyCode!==wysihtml5.BACKSPACE_KEY?blockElement.nodeName.match(/H[1-6]/)&&keyCode===wysihtml5.ENTER_KEY&&setTimeout(function(){unwrap(composer.selection.getSelectedNode())},0):setTimeout(function(){var selectedNode=composer.selection.getSelectedNode(),list,p;if(!selectedNode)return;list=dom.getParentElement(selectedNode,{nodeName:LIST_TAGS},2);if(list)return;unwrap(selectedNode)},0);return}keyCode===wysihtml5.ENTER_KEY&&!wysihtml5.browser.insertsLineBreaksOnReturn()&&(composer.selection.surround(document.createElement("p")),event.preventDefault())}dom.observe(composer.element.ownerDocument,"keydown",keyDown)}}(wysihtml5),function(wysihtml5){var CLASS_NAME="wysihtml5-quirks-redraw";wysihtml5.quirks.redraw=function(element){wysihtml5.dom.addClass(element,CLASS_NAME),wysihtml5.dom.removeClass(element,CLASS_NAME);try{var doc=element.ownerDocument;doc.execCommand("italic",!1,null),doc.execCommand("italic",!1,null)}catch(e){}}}(wysihtml5),function(wysihtml5){function _getCumulativeOffsetTop(element){var top=0;if(element.parentNode)do top+=element.offsetTop||0,element=element.offsetParent;while(element);return top}var dom=wysihtml5.dom;wysihtml5.Selection=Base.extend({constructor:function(editor){window.rangy.init(),this.editor=editor,this.composer=editor.composer,this.doc=this.composer.doc},getBookmark:function(){var range=this.getRange();return range&&range.cloneRange()},setBookmark:function(bookmark){if(!bookmark)return;this.setSelection(bookmark)},setBefore:function(node){var range=rangy.createRange(this.doc);return range.setStartBefore(node),range.setEndBefore(node),this.setSelection(range)},setAfter:function(node){var range=rangy.createRange(this.doc);return range.setStartAfter(node),range.setEndAfter(node),this.setSelection(range)},selectNode:function(node){var range=rangy.createRange(this.doc),isElement=node.nodeType===wysihtml5.ELEMENT_NODE,canHaveHTML="canHaveHTML"in node?node.canHaveHTML:node.nodeName!=="IMG",content=isElement?node.innerHTML:node.data,isEmpty=content===""||content===wysihtml5.INVISIBLE_SPACE,displayStyle=dom.getStyle("display").from(node),isBlockElement=displayStyle==="block"||displayStyle==="list-item";if(isEmpty&&isElement&&canHaveHTML)try{node.innerHTML=wysihtml5.INVISIBLE_SPACE}catch(e){}canHaveHTML?range.selectNodeContents(node):range.selectNode(node),canHaveHTML&&isEmpty&&isElement?range.collapse(isBlockElement):canHaveHTML&&isEmpty&&(range.setStartAfter(node),range.setEndAfter(node)),this.setSelection(range)},getSelectedNode:function(controlRange){var selection,range;if(controlRange&&this.doc.selection&&this.doc.selection.type==="Control"){range=this.doc.selection.createRange();if(range&&range.length)return range.item(0)}return selection=this.getSelection(this.doc),selection.focusNode===selection.anchorNode?selection.focusNode:(range=this.getRange(this.doc),range?range.commonAncestorContainer:this.doc.body)},executeAndRestore:function(method,restoreScrollPosition){var body=this.doc.body,oldScrollTop=restoreScrollPosition&&body.scrollTop,oldScrollLeft=restoreScrollPosition&&body.scrollLeft,className="_wysihtml5-temp-placeholder",placeholderHTML='<span class="'+className+'">'+wysihtml5.INVISIBLE_SPACE+"</span>",range=this.getRange(this.doc),newRange;if(!range){method(body,body);return}var node=range.createContextualFragment(placeholderHTML);range.insertNode(node);try{method(range.startContainer,range.endContainer)}catch(e3){setTimeout(function(){throw e3},0)}caretPlaceholder=this.doc.querySelector("."+className),caretPlaceholder?(newRange=rangy.createRange(this.doc),newRange.selectNode(caretPlaceholder),newRange.deleteContents(),this.setSelection(newRange)):body.focus(),restoreScrollPosition&&(body.scrollTop=oldScrollTop,body.scrollLeft=oldScrollLeft);try{caretPlaceholder.parentNode.removeChild(caretPlaceholder)}catch(e4){}},executeAndRestoreSimple:function(method){var range=this.getRange(),body=this.doc.body,newRange,firstNode,lastNode,textNodes,rangeBackup;if(!range){method(body,body);return}textNodes=range.getNodes([3]),firstNode=textNodes[0]||range.startContainer,lastNode=textNodes[textNodes.length-1]||range.endContainer,rangeBackup={collapsed:range.collapsed,startContainer:firstNode,startOffset:firstNode===range.startContainer?range.startOffset:0,endContainer:lastNode,endOffset:lastNode===range.endContainer?range.endOffset:lastNode.length};try{method(range.startContainer,range.endContainer)}catch(e){setTimeout(function(){throw e},0)}newRange=rangy.createRange(this.doc);try{newRange.setStart(rangeBackup.startContainer,rangeBackup.startOffset)}catch(e1){}try{newRange.setEnd(rangeBackup.endContainer,rangeBackup.endOffset)}catch(e2){}try{this.setSelection(newRange)}catch(e3){}},insertHTML:function(html){var range=rangy.createRange(this.doc),node=range.createContextualFragment(html),lastChild=node.lastChild;this.insertNode(node),lastChild&&this.setAfter(lastChild)},insertNode:function(node){var range=this.getRange();range&&range.insertNode(node)},surround:function(node){var range=this.getRange();if(!range)return;try{range.surroundContents(node),this.selectNode(node)}catch(e){node.appendChild(range.extractContents()),range.insertNode(node)}},scrollIntoView:function(){var doc=this.doc,hasScrollBars=doc.documentElement.scrollHeight>doc.documentElement.offsetHeight,tempElement=doc._wysihtml5ScrollIntoViewElement=doc._wysihtml5ScrollIntoViewElement||function(){var element=doc.createElement("span");return element.innerHTML=wysihtml5.INVISIBLE_SPACE,element}(),offsetTop;hasScrollBars&&(this.insertNode(tempElement),offsetTop=_getCumulativeOffsetTop(tempElement),tempElement.parentNode.removeChild(tempElement),offsetTop>doc.body.scrollTop&&(doc.body.scrollTop=offsetTop))},selectLine:function(){wysihtml5.browser.supportsSelectionModify()?this._selectLine_W3C():this.doc.selection&&this._selectLine_MSIE()},_selectLine_W3C:function(){var win=this.doc.defaultView,selection=win.getSelection();selection.modify("extend","left","lineboundary"),selection.modify("extend","right","lineboundary")},_selectLine_MSIE:function(){var range=this.doc.selection.createRange(),rangeTop=range.boundingTop,rangeHeight=range.boundingHeight,scrollWidth=this.doc.body.scrollWidth,rangeBottom,rangeEnd,measureNode,i,j;if(!range.moveToPoint)return;rangeTop===0&&(measureNode=this.doc.createElement("span"),this.insertNode(measureNode),rangeTop=measureNode.offsetTop,measureNode.parentNode.removeChild(measureNode)),rangeTop+=1;for(i=-10;i<scrollWidth;i+=2)try{range.moveToPoint(i,rangeTop);break}catch(e1){}rangeBottom=rangeTop,rangeEnd=this.doc.selection.createRange();for(j=scrollWidth;j>=0;j--)try{rangeEnd.moveToPoint(j,rangeBottom);break}catch(e2){}range.setEndPoint("EndToEnd",rangeEnd),range.select()},getText:function(){var selection=this.getSelection();return selection?selection.toString():""},getNodes:function(nodeType,filter){var range=this.getRange();return range?range.getNodes([nodeType],filter):[]},getRange:function(){var selection=this.getSelection();return selection&&selection.rangeCount&&selection.getRangeAt(0)},getSelection:function(){return rangy.getSelection(this.doc.defaultView||this.doc.parentWindow)},setSelection:function(range){var win=this.doc.defaultView||this.doc.parentWindow,selection=rangy.getSelection(win);return selection.setSingleRange(range)}})}(wysihtml5),function(wysihtml5,rangy){function hasClass(el,cssClass,regExp){if(!el.className)return!1;var matchingClassNames=el.className.match(regExp)||[];return matchingClassNames[matchingClassNames.length-1]===cssClass}function addClass(el,cssClass,regExp){el.className?(removeClass(el,regExp),el.className+=" "+cssClass):el.className=cssClass}function removeClass(el,regExp){el.className&&(el.className=el.className.replace(regExp,""))}function hasSameClasses(el1,el2){return el1.className.replace(REG_EXP_WHITE_SPACE," ")==el2.className.replace(REG_EXP_WHITE_SPACE," ")}function replaceWithOwnChildren(el){var parent=el.parentNode;while(el.firstChild)parent.insertBefore(el.firstChild,el);parent.removeChild(el)}function elementsHaveSameNonClassAttributes(el1,el2){if(el1.attributes.length!=el2.attributes.length)return!1;for(var i=0,len=el1.attributes.length,attr1,attr2,name;i<len;++i){attr1=el1.attributes[i],name=attr1.name;if(name!="class"){attr2=el2.attributes.getNamedItem(name);if(attr1.specified!=attr2.specified)return!1;if(attr1.specified&&attr1.nodeValue!==attr2.nodeValue)return!1}}return!0}function isSplitPoint(node,offset){return rangy.dom.isCharacterDataNode(node)?offset==0?!!node.previousSibling:offset==node.length?!!node.nextSibling:!0:offset>0&&offset<node.childNodes.length}function splitNodeAt(node,descendantNode,descendantOffset){var newNode;rangy.dom.isCharacterDataNode(descendantNode)&&(descendantOffset==0?(descendantOffset=rangy.dom.getNodeIndex(descendantNode),descendantNode=descendantNode.parentNode):descendantOffset==descendantNode.length?(descendantOffset=rangy.dom.getNodeIndex(descendantNode)+1,descendantNode=descendantNode.parentNode):newNode=rangy.dom.splitDataNode(descendantNode,descendantOffset));if(!newNode){newNode=descendantNode.cloneNode(!1),newNode.id&&newNode.removeAttribute("id");var child;while(child=descendantNode.childNodes[descendantOffset])newNode.appendChild(child);rangy.dom.insertAfter(newNode,descendantNode)}return descendantNode==node?newNode:splitNodeAt(node,newNode.parentNode,rangy.dom.getNodeIndex(newNode))}function Merge(firstNode){this.isElementMerge=firstNode.nodeType==wysihtml5.ELEMENT_NODE,this.firstTextNode=this.isElementMerge?firstNode.lastChild:firstNode,this.textNodes=[this.firstTextNode]}function HTMLApplier(tagNames,cssClass,similarClassRegExp,normalize){this.tagNames=tagNames||[defaultTagName],this.cssClass=cssClass||"",this.similarClassRegExp=similarClassRegExp,this.normalize=normalize,this.applyToAnyTagName=!1}var defaultTagName="span",REG_EXP_WHITE_SPACE=/\s+/g;Merge.prototype={doMerge:function(){var textBits=[],textNode,parent,text;for(var i=0,len=this.textNodes.length;i<len;++i)textNode=this.textNodes[i],parent=textNode.parentNode,textBits[i]=textNode.data,i&&(parent.removeChild(textNode),parent.hasChildNodes()||parent.parentNode.removeChild(parent));return this.firstTextNode.data=text=textBits.join(""),text},getLength:function(){var i=this.textNodes.length,len=0;while(i--)len+=this.textNodes[i].length;return len},toString:function(){var textBits=[];for(var i=0,len=this.textNodes.length;i<len;++i)textBits[i]="'"+this.textNodes[i].data+"'";return"[Merge("+textBits.join(",")+")]"}},HTMLApplier.prototype={getAncestorWithClass:function(node){var cssClassMatch;while(node){cssClassMatch=this.cssClass?hasClass(node,this.cssClass,this.similarClassRegExp):!0;if(node.nodeType==wysihtml5.ELEMENT_NODE&&rangy.dom.arrayContains(this.tagNames,node.tagName.toLowerCase())&&cssClassMatch)return node;node=node.parentNode}return!1},postApply:function(textNodes,range){var firstNode=textNodes[0],lastNode=textNodes[textNodes.length-1],merges=[],currentMerge,rangeStartNode=firstNode,rangeEndNode=lastNode,rangeStartOffset=0,rangeEndOffset=lastNode.length,textNode,precedingTextNode;for(var i=0,len=textNodes.length;i<len;++i)textNode=textNodes[i],precedingTextNode=this.getAdjacentMergeableTextNode(textNode.parentNode,!1),precedingTextNode?(currentMerge||(currentMerge=new Merge(precedingTextNode),merges.push(currentMerge)),currentMerge.textNodes.push(textNode),textNode===firstNode&&(rangeStartNode=currentMerge.firstTextNode,rangeStartOffset=rangeStartNode.length),textNode===lastNode&&(rangeEndNode=currentMerge.firstTextNode,rangeEndOffset=currentMerge.getLength())):currentMerge=null;var nextTextNode=this.getAdjacentMergeableTextNode(lastNode.parentNode,!0);nextTextNode&&(currentMerge||(currentMerge=new Merge(lastNode),merges.push(currentMerge)),currentMerge.textNodes.push(nextTextNode));if(merges.length){for(i=0,len=merges.length;i<len;++i)merges[i].doMerge();range.setStart(rangeStartNode,rangeStartOffset),range.setEnd(rangeEndNode,rangeEndOffset)}},getAdjacentMergeableTextNode:function(node,forward){var isTextNode=node.nodeType==wysihtml5.TEXT_NODE,el=isTextNode?node.parentNode:node,adjacentNode,propName=forward?"nextSibling":"previousSibling";if(isTextNode){adjacentNode=node[propName];if(adjacentNode&&adjacentNode.nodeType==wysihtml5.TEXT_NODE)return adjacentNode}else{adjacentNode=el[propName];if(adjacentNode&&this.areElementsMergeable(node,adjacentNode))return adjacentNode[forward?"firstChild":"lastChild"]}return null},areElementsMergeable:function(el1,el2){return rangy.dom.arrayContains(this.tagNames,(el1.tagName||"").toLowerCase())&&rangy.dom.arrayContains(this.tagNames,(el2.tagName||"").toLowerCase())&&hasSameClasses(el1,el2)&&elementsHaveSameNonClassAttributes(el1,el2)},createContainer:function(doc){var el=doc.createElement(this.tagNames[0]);return this.cssClass&&(el.className=this.cssClass),el},applyToTextNode:function(textNode){var parent=textNode.parentNode;if(parent.childNodes.length==1&&rangy.dom.arrayContains(this.tagNames,parent.tagName.toLowerCase()))this.cssClass&&addClass(parent,this.cssClass,this.similarClassRegExp);else{var el=this.createContainer(rangy.dom.getDocument(textNode));textNode.parentNode.insertBefore(el,textNode),el.appendChild(textNode)}},isRemovable:function(el){return rangy.dom.arrayContains(this.tagNames,el.tagName.toLowerCase())&&wysihtml5.lang.string(el.className).trim()==this.cssClass},undoToTextNode:function(textNode,range,ancestorWithClass){if(!range.containsNode(ancestorWithClass)){var ancestorRange=range.cloneRange();ancestorRange.selectNode(ancestorWithClass),ancestorRange.isPointInRange(range.endContainer,range.endOffset)&&isSplitPoint(range.endContainer,range.endOffset)&&(splitNodeAt(ancestorWithClass,range.endContainer,range.endOffset),range.setEndAfter(ancestorWithClass)),ancestorRange.isPointInRange(range.startContainer,range.startOffset)&&isSplitPoint(range.startContainer,range.startOffset)&&(ancestorWithClass=splitNodeAt(ancestorWithClass,range.startContainer,range.startOffset))}this.similarClassRegExp&&removeClass(ancestorWithClass,this.similarClassRegExp),this.isRemovable(ancestorWithClass)&&replaceWithOwnChildren(ancestorWithClass)},applyToRange:function(range){var textNodes=range.getNodes([wysihtml5.TEXT_NODE]);if(!textNodes.length)try{var node=this.createContainer(range.endContainer.ownerDocument);range.surroundContents(node),this.selectNode(range,node);return}catch(e){}range.splitBoundaries(),textNodes=range.getNodes([wysihtml5.TEXT_NODE]);if(textNodes.length){var textNode;for(var i=0,len=textNodes.length;i<len;++i)textNode=textNodes[i],this.getAncestorWithClass(textNode)||this.applyToTextNode(textNode);range.setStart(textNodes[0],0),textNode=textNodes[textNodes.length-1],range.setEnd(textNode,textNode.length),this.normalize&&this.postApply(textNodes,range)}},undoToRange:function(range){var textNodes=range.getNodes([wysihtml5.TEXT_NODE]),textNode,ancestorWithClass;if(textNodes.length)range.splitBoundaries(),textNodes=range.getNodes([wysihtml5.TEXT_NODE]);else{var doc=range.endContainer.ownerDocument,node=doc.createTextNode(wysihtml5.INVISIBLE_SPACE);range.insertNode(node),range.selectNode(node),textNodes=[node]}for(var i=0,len=textNodes.length;i<len;++i)textNode=textNodes[i],ancestorWithClass=this.getAncestorWithClass(textNode),ancestorWithClass&&this.undoToTextNode(textNode,range,ancestorWithClass);len==1?this.selectNode(range,textNodes[0]):(range.setStart(textNodes[0],0),textNode=textNodes[textNodes.length-1],range.setEnd(textNode,textNode.length),this.normalize&&this.postApply(textNodes,range))},selectNode:function(range,node){var isElement=node.nodeType===wysihtml5.ELEMENT_NODE,canHaveHTML="canHaveHTML"in node?node.canHaveHTML:!0,content=isElement?node.innerHTML:node.data,isEmpty=content===""||content===wysihtml5.INVISIBLE_SPACE;if(isEmpty&&isElement&&canHaveHTML)try{node.innerHTML=wysihtml5.INVISIBLE_SPACE}catch(e){}range.selectNodeContents(node),isEmpty&&isElement?range.collapse(!1):isEmpty&&(range.setStartAfter(node),range.setEndAfter(node))},getTextSelectedByRange:function(textNode,range){var textRange=range.cloneRange();textRange.selectNodeContents(textNode);var intersectionRange=textRange.intersection(range),text=intersectionRange?intersectionRange.toString():"";return textRange.detach(),text},isAppliedToRange:function(range){var ancestors=[],ancestor,textNodes=range.getNodes([wysihtml5.TEXT_NODE]);if(!textNodes.length)return ancestor=this.getAncestorWithClass(range.startContainer),ancestor?[ancestor]:!1;for(var i=0,len=textNodes.length,selectedText;i<len;++i){selectedText=this.getTextSelectedByRange(textNodes[i],range),ancestor=this.getAncestorWithClass(textNodes[i]);if(selectedText!=""&&!ancestor)return!1;ancestors.push(ancestor)}return ancestors},toggleRange:function(range){this.isAppliedToRange(range)?this.undoToRange(range):this.applyToRange(range)}},wysihtml5.selection.HTMLApplier=HTMLApplier}(wysihtml5,rangy),wysihtml5.Commands=Base.extend({constructor:function(editor){this.editor=editor,this.composer=editor.composer,this.doc=this.composer.doc},support:function(command){return wysihtml5.browser.supportsCommand(this.doc,command)},exec:function(command,value){var obj=wysihtml5.commands[command],method=obj&&obj.exec;this.editor.fire("beforecommand:composer");if(method)return method.call(obj,this.composer,command,value);try{return this.doc.execCommand(command,!1,value)}catch(e){}this.editor.fire("aftercommand:composer")},state:function(command,commandValue){var obj=wysihtml5.commands[command],method=obj&&obj.state;if(method)return method.call(obj,this.composer,command,commandValue);try{return this.doc.queryCommandState(command)}catch(e){return!1}},value:function(command){var obj=wysihtml5.commands[command],method=obj&&obj.value;if(method)return method.call(obj,this.composer,command);try{return this.doc.queryCommandValue(command)}catch(e){return null}}}),function(wysihtml5){var undef;wysihtml5.commands.bold={exec:function(composer,command){return wysihtml5.commands.formatInline.exec(composer,command,"b")},state:function(composer,command,color){return wysihtml5.commands.formatInline.state(composer,command,"b")},value:function(){return undef}}}(wysihtml5),function(wysihtml5){function _removeFormat(composer,anchors){var length=anchors.length,i=0,anchor,codeElement,textContent;for(;i<length;i++)anchor=anchors[i],codeElement=dom.getParentElement(anchor,{nodeName:"code"}),textContent=dom.getTextContent(anchor),textContent.match(dom.autoLink.URL_REG_EXP)&&!codeElement?codeElement=dom.renameElement(anchor,"code"):dom.replaceWithChildNodes(anchor)}function _format(composer,attributes){var doc=composer.doc,tempClass="_wysihtml5-temp-"+ +(new Date),tempClassRegExp=/non-matching-class/g,i=0,length,anchors,anchor,hasElementChild,isEmpty,elementToSetCaretAfter,textContent,whiteSpace,j;wysihtml5.commands.formatInline.exec(composer,undef,NODE_NAME,tempClass,tempClassRegExp),anchors=doc.querySelectorAll(NODE_NAME+"."+tempClass),length=anchors.length;for(;i<length;i++){anchor=anchors[i],anchor.removeAttribute("class");for(j in attributes)anchor.setAttribute(j,attributes[j])}elementToSetCaretAfter=anchor,length===1&&(textContent=dom.getTextContent(anchor),hasElementChild=!!anchor.querySelector("*"),isEmpty=textContent===""||textContent===wysihtml5.INVISIBLE_SPACE,!hasElementChild&&isEmpty&&(dom.setTextContent(anchor,anchor.href),whiteSpace=doc.createTextNode(" "),composer.selection.setAfter(anchor),composer.selection.insertNode(whiteSpace),elementToSetCaretAfter=whiteSpace)),composer.selection.setAfter(elementToSetCaretAfter)}var undef,NODE_NAME="A",dom=wysihtml5.dom;wysihtml5.commands.createLink={exec:function(composer,command,value){var anchors=this.state(composer,command);anchors?composer.selection.executeAndRestore(function(){_removeFormat(composer,anchors)}):(value=typeof value=="object"?value:{href:value},_format(composer,value))},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"A")},value:function(){return undef}}}(wysihtml5),function(wysihtml5){function _removeFormat(composer,anchors){var length=anchors.length,i=0,anchor,codeElement,textContent;for(;i<length;i++)anchor=anchors[i],codeElement=dom.getParentElement(anchor,{nodeName:"code"}),textContent=dom.getTextContent(anchor),textContent.match(dom.autoLink.URL_REG_EXP)&&!codeElement?codeElement=dom.renameElement(anchor,"code"):dom.replaceWithChildNodes(anchor)}function _format(composer,attributes){var node,table,level=100;node=composer.selection.getSelectedNode();while(level--&&node.parentNode&&node.parentNode.tagName!="BODY")node=node.parentNode;table=document.createElement("table"),table.innerHTML="<tr><td>&nbsp;</td></tr>",node.parentNode.insertBefore(table,node.nextSibling)}function _insertColumn(composer,position){var node,table,rows,cell,index;composer.selection.getSelection().collapseToEnd(),node=dom.getParentElement(composer.selection.getSelectedNode(),{nodeName:"TD"});if(node){index=node.cellIndex,table=dom.getParentElement(node,{nodeName:"TABLE"}),rows=table.querySelectorAll("tr");for(var i=0;i<rows.length;i++){var cell=document.createElement("td");cell.innerHTML="&nbsp;",position=="before"?rows[i].insertBefore(cell,rows[i].childNodes[index]):rows[i].insertBefore(cell,rows[i].childNodes[index].nextSibling)}}}var undef,NODE_NAME="TABLE",dom=wysihtml5.dom;wysihtml5.commands.deleteTable={exec:function(composer,command){var node;composer.selection.getSelection().collapseToEnd(),node=dom.getParentElement(composer.selection.getSelectedNode(),{nodeName:"TABLE"}),node.parentNode.removeChild(node)}},wysihtml5.commands.deleteRow={exec:function(composer,command){var node,table;composer.selection.getSelection().collapseToEnd(),node=dom.getParentElement(composer.selection.getSelectedNode(),{nodeName:"TR"});if(node){table=dom.getParentElement(node,{nodeName:"TABLE"});if(table.getElementsByTagName("TR").length==1){wysihtml5.commands.deleteTable.exec(composer);return}node.parentNode.removeChild(node)}}},wysihtml5.commands.deleteColumn={exec:function(composer,command){var node,table,rows,cell,index;composer.selection.getSelection().collapseToEnd(),node=dom.getParentElement(composer.selection.getSelectedNode(),{nodeName:"TD"});if(node){if(node.parentNode.childNodes.length==1){wysihtml5.commands.deleteTable.exec(composer);return}index=node.cellIndex,table=dom.getParentElement(node,{nodeName:"TABLE"}),rows=table.querySelectorAll("tr");for(var i=0;i<rows.length;i++)rows[i].removeChild(rows[i].childNodes[index])}}},wysihtml5.commands.insertColumnLeft={exec:function(composer,command){_insertColumn(composer,"before")}},wysihtml5.commands.insertColumnRight={exec:function(composer,command){_insertColumn(composer,"after")}},wysihtml5.commands.insertRowAbove={exec:function(composer,command){var node,cloned;composer.selection.getSelection().collapseToEnd(),node=dom.getParentElement(composer.selection.getSelectedNode(),{nodeName:"TR"}),cloned=node.cloneNode(!0),node.parentNode.insertBefore(cloned,node)}},wysihtml5.commands.insertRowBelow={exec:function(composer,command){var node,cloned;composer.selection.getSelection().collapseToEnd(),node=dom.getParentElement(composer.selection.getSelectedNode(),{nodeName:"TR"}),cloned=node.cloneNode(!0),node.parentNode.insertBefore(cloned,node.nextSibling)}},wysihtml5.commands.createTable={exec:function(composer,command,value){var table=this.state(composer,command);if(table)return!0;_format(composer,value)},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"TABLE")},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,REG_EXP=/wysiwyg-font-size-[a-z\-]+/g;wysihtml5.commands.fontSize={exec:function(composer,command,size){return wysihtml5.commands.formatInline.exec(composer,command,"span","wysiwyg-font-size-"+size,REG_EXP)},state:function(composer,command,size){return wysihtml5.commands.formatInline.state(composer,command,"span","wysiwyg-font-size-"+size,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,REG_EXP=/wysiwyg-color-[a-z]+/g;wysihtml5.commands.foreColor={exec:function(composer,command,color){return wysihtml5.commands.formatInline.exec(composer,command,"span","wysiwyg-color-"+color,REG_EXP)},state:function(composer,command,color){return wysihtml5.commands.formatInline.state(composer,command,"span","wysiwyg-color-"+color,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){function _addClass(element,className,classRegExp){element.className?(_removeClass(element,classRegExp),element.className+=" "+className):element.className=className}function _removeClass(element,classRegExp){element.className=element.className.replace(classRegExp,"")}function _isBlankTextNode(node){return node.nodeType===wysihtml5.TEXT_NODE&&!wysihtml5.lang.string(node.data).trim()}function _getPreviousSiblingThatIsNotBlank(node){var previousSibling=node.previousSibling;while(previousSibling&&_isBlankTextNode(previousSibling))previousSibling=previousSibling.previousSibling;return previousSibling}function _getNextSiblingThatIsNotBlank(node){var nextSibling=node.nextSibling;while(nextSibling&&_isBlankTextNode(nextSibling))nextSibling=nextSibling.nextSibling;return nextSibling}function _addLineBreakBeforeAndAfter(node){var doc=node.ownerDocument,nextSibling=_getNextSiblingThatIsNotBlank(node),previousSibling=_getPreviousSiblingThatIsNotBlank(node);nextSibling&&!_isLineBreakOrBlockElement(nextSibling)&&node.parentNode.insertBefore(doc.createElement("br"),nextSibling),previousSibling&&!_isLineBreakOrBlockElement(previousSibling)&&node.parentNode.insertBefore(doc.createElement("br"),node)}function _removeLineBreakBeforeAndAfter(node){var nextSibling=_getNextSiblingThatIsNotBlank(node),previousSibling=_getPreviousSiblingThatIsNotBlank(node);nextSibling&&_isLineBreak(nextSibling)&&nextSibling.parentNode.removeChild(nextSibling),previousSibling&&_isLineBreak(previousSibling)&&previousSibling.parentNode.removeChild(previousSibling)}function _removeLastChildIfLineBreak(node){var lastChild=node.lastChild;lastChild&&_isLineBreak(lastChild)&&lastChild.parentNode.removeChild(lastChild)}function _isLineBreak(node){return node.nodeName==="BR"}function _isLineBreakOrBlockElement(element){return _isLineBreak(element)?!0:dom.getStyle("display").from(element)==="block"?!0:!1}function _execCommand(doc,command,nodeName,className){if(className)var eventListener=dom.observe(doc,"DOMNodeInserted",function(event){var target=event.target,displayStyle;if(target.nodeType!==wysihtml5.ELEMENT_NODE)return;displayStyle=dom.getStyle("display").from(target),displayStyle.substr(0,6)!=="inline"&&(target.className+=" "+className)});doc.execCommand(command,!1,nodeName),eventListener&&eventListener.stop()}function _selectLineAndWrap(composer,element){composer.selection.selectLine(),composer.selection.surround(element),_removeLineBreakBeforeAndAfter(element),_removeLastChildIfLineBreak(element),composer.selection.selectNode(element)}function _hasClasses(element){return!!wysihtml5.lang.string(element.className).trim()}var undef,dom=wysihtml5.dom,DEFAULT_NODE_NAME="DIV",BLOCK_ELEMENTS_GROUP=["H1","H2","H3","H4","H5","H6","P","BLOCKQUOTE",DEFAULT_NODE_NAME];wysihtml5.commands.formatBlock={exec:function(composer,command,nodeName,className,classRegExp){var doc=composer.doc,blockElement=this.state(composer,command,nodeName,className,classRegExp),selectedNode;nodeName=typeof nodeName=="string"?nodeName.toUpperCase():nodeName;if(blockElement){composer.selection.executeAndRestoreSimple(function(){classRegExp&&_removeClass(blockElement,classRegExp);var hasClasses=_hasClasses(blockElement);!hasClasses&&blockElement.nodeName===(nodeName||DEFAULT_NODE_NAME)?(_addLineBreakBeforeAndAfter(blockElement),dom.replaceWithChildNodes(blockElement)):hasClasses&&dom.renameElement(blockElement,DEFAULT_NODE_NAME)});return}if(nodeName===null||wysihtml5.lang.array(BLOCK_ELEMENTS_GROUP).contains(nodeName)){selectedNode=composer.selection.getSelectedNode(),blockElement=dom.getParentElement(selectedNode,{nodeName:BLOCK_ELEMENTS_GROUP});if(blockElement){composer.selection.executeAndRestoreSimple(function(){nodeName&&(blockElement=dom.renameElement(blockElement,nodeName)),className&&_addClass(blockElement,className,classRegExp)});return}}if(composer.commands.support(command)){_execCommand(doc,command,nodeName||DEFAULT_NODE_NAME,className);return}blockElement=doc.createElement(nodeName||DEFAULT_NODE_NAME),className&&(blockElement.className=className),_selectLineAndWrap(composer,blockElement)},state:function(composer,command,nodeName,className,classRegExp){nodeName=typeof nodeName=="string"?nodeName.toUpperCase():nodeName;var selectedNode=composer.selection.getSelectedNode();return dom.getParentElement(selectedNode,{nodeName:nodeName,className:className,classRegExp:classRegExp})},value:function(){return undef}}}(wysihtml5),function(wysihtml5){function _getTagNames(tagName){var alias=ALIAS_MAPPING[tagName];return alias?[tagName.toLowerCase(),alias.toLowerCase()]:[tagName.toLowerCase()]}function _getApplier(tagName,className,classRegExp){var identifier=tagName+":"+className;return htmlApplier[identifier]||(htmlApplier[identifier]=new wysihtml5.selection.HTMLApplier(_getTagNames(tagName),className,classRegExp,!0)),htmlApplier[identifier]}var undef,ALIAS_MAPPING={strong:"b",em:"i",b:"strong",i:"em"},htmlApplier={};wysihtml5.commands.formatInline={exec:function(composer,command,tagName,className,classRegExp){var range=composer.selection.getRange();if(!range)return!1;_getApplier(tagName,className,classRegExp).toggleRange(range),composer.selection.setSelection(range)},state:function(composer,command,tagName,className,classRegExp){var doc=composer.doc,aliasTagName=ALIAS_MAPPING[tagName]||tagName,range;return!wysihtml5.dom.hasElementWithTagName(doc,tagName)&&!wysihtml5.dom.hasElementWithTagName(doc,aliasTagName)?!1:className&&!wysihtml5.dom.hasElementWithClassName(doc,className)?!1:(range=composer.selection.getRange(),range?_getApplier(tagName,className,classRegExp).isAppliedToRange(range):!1)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.insertHTML={exec:function(composer,command,html){composer.commands.support(command)?composer.doc.execCommand(command,!1,html):composer.selection.insertHTML(html)},state:function(){return!1},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var NODE_NAME="IMG";wysihtml5.commands.insertImage={exec:function(composer,command,value){value=typeof value=="object"?value:{src:value};var doc=composer.doc,image=this.state(composer),textNode,i,parent;if(image){composer.selection.setBefore(image),parent=image.parentNode,parent.removeChild(image),wysihtml5.dom.removeEmptyTextNodes(parent),parent.nodeName==="A"&&!parent.firstChild&&(composer.selection.setAfter(parent),parent.parentNode.removeChild(parent)),wysihtml5.quirks.redraw(composer.element);return}image=doc.createElement(NODE_NAME);for(i in value)image[i]=value[i];composer.selection.insertNode(image),wysihtml5.browser.hasProblemsSettingCaretAfterImg()?(textNode=doc.createTextNode(wysihtml5.INVISIBLE_SPACE),composer.selection.insertNode(textNode),composer.selection.setAfter(textNode)):composer.selection.setAfter(image)},state:function(composer){var doc=composer.doc,selectedNode,text,imagesInSelection;return wysihtml5.dom.hasElementWithTagName(doc,NODE_NAME)?(selectedNode=composer.selection.getSelectedNode(),selectedNode?selectedNode.nodeName===NODE_NAME?selectedNode:selectedNode.nodeType!==wysihtml5.ELEMENT_NODE?!1:(text=composer.selection.getText(),text=wysihtml5.lang.string(text).trim(),text?!1:(imagesInSelection=composer.selection.getNodes(wysihtml5.ELEMENT_NODE,function(node){return node.nodeName==="IMG"}),imagesInSelection.length!==1?!1:imagesInSelection[0])):!1):!1},value:function(composer){var image=this.state(composer);return image&&image.src}}}(wysihtml5),function(wysihtml5){var undef,LINE_BREAK="<br>"+(wysihtml5.browser.needsSpaceAfterLineBreak()?" ":"");wysihtml5.commands.insertLineBreak={exec:function(composer,command){composer.commands.support(command)?(composer.doc.execCommand(command,!1,null),wysihtml5.browser.autoScrollsToCaret()||composer.selection.scrollIntoView()):composer.commands.exec("insertHTML",LINE_BREAK)},state:function(){return!1},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.insertOrderedList={exec:function(composer,command){var doc=composer.doc,selectedNode,isEmpty,tempElement,list;if(composer.commands.support(command))doc.execCommand(command,!1,null);else{selectedNode=composer.selection.getSelectedNode(),list=wysihtml5.dom.getParentElement(selectedNode,{nodeName:["UL","OL"]},4);if(!list){tempElement=doc.createElement("span"),composer.selection.surround(tempElement),isEmpty=tempElement.innerHTML===""||tempElement.innerHTML===wysihtml5.INVISIBLE_SPACE,composer.selection.executeAndRestoreSimple(function(){list=wysihtml5.dom.convertToList(tempElement,"ol")}),isEmpty&&composer.selection.selectNode(list.querySelector("li"));return}composer.selection.executeAndRestoreSimple(function(){list.nodeName==="OL"?wysihtml5.dom.resolveList(list):(list.nodeName==="UL"||list.nodeName==="MENU")&&wysihtml5.dom.renameElement(list,"ol")})}},state:function(composer,command){try{return composer.doc.queryCommandState(command)}catch(e){return!1}},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.insertUnorderedList={exec:function(composer,command){var doc=composer.doc,selectedNode,isEmpty,tempElement,list;if(composer.commands.support(command))doc.execCommand(command,!1,null);else{selectedNode=composer.selection.getSelectedNode(),list=wysihtml5.dom.getParentElement(selectedNode,{nodeName:["UL","OL"]});if(!list){tempElement=doc.createElement("span"),composer.selection.surround(tempElement),isEmpty=tempElement.innerHTML===""||tempElement.innerHTML===wysihtml5.INVISIBLE_SPACE,composer.selection.executeAndRestoreSimple(function(){list=wysihtml5.dom.convertToList(tempElement,"ul")}),isEmpty&&composer.selection.selectNode(list.querySelector("li"));return}composer.selection.executeAndRestoreSimple(function(){list.nodeName==="UL"?wysihtml5.dom.resolveList(list):(list.nodeName==="OL"||list.nodeName==="MENU")&&wysihtml5.dom.renameElement(list,"ul")})}},state:function(composer,command){try{return composer.doc.queryCommandState(command)}catch(e){return!1}},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.italic={exec:function(composer,command){return wysihtml5.commands.formatInline.exec(composer,command,"i")},state:function(composer,command,color){return wysihtml5.commands.formatInline.state(composer,command,"i")},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,CLASS_NAME="wysiwyg-text-align-center",REG_EXP=/wysiwyg-text-align-[a-z]+/g;wysihtml5.commands.justifyCenter={exec:function(composer,command){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer,command){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,CLASS_NAME="wysiwyg-text-align-left",REG_EXP=/wysiwyg-text-align-[a-z]+/g;wysihtml5.commands.justifyLeft={exec:function(composer,command){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer,command){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,CLASS_NAME="wysiwyg-text-align-right",REG_EXP=/wysiwyg-text-align-[a-z]+/g;wysihtml5.commands.justifyRight={exec:function(composer,command){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer,command){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.underline={exec:function(composer,command){return wysihtml5.commands.formatInline.exec(composer,command,"u")},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"u")},value:function(){return undef}}}(wysihtml5),function(wysihtml5){function cleanTempElements(doc){var tempElement;while(tempElement=doc.querySelector("._wysihtml5-temp"))tempElement.parentNode.removeChild(tempElement)}var Z_KEY=90,Y_KEY=89,BACKSPACE_KEY=8,DELETE_KEY=46,MAX_HISTORY_ENTRIES=40,UNDO_HTML='<span id="_wysihtml5-undo" class="_wysihtml5-temp">'+wysihtml5.INVISIBLE_SPACE+"</span>",REDO_HTML='<span id="_wysihtml5-redo" class="_wysihtml5-temp">'+wysihtml5.INVISIBLE_SPACE+"</span>",dom=wysihtml5.dom;wysihtml5.UndoManager=wysihtml5.lang.Dispatcher.extend({constructor:function(editor){this.editor=editor,this.composer=editor.composer,this.element=this.composer.element,this.history=[this.composer.getValue()],this.position=1,this.composer.commands.support("insertHTML")&&this._observe()},_observe:function(){var that=this,doc=this.composer.sandbox.getDocument(),lastKey;dom.observe(this.element,"keydown",function(event){if(event.altKey||!event.ctrlKey&&!event.metaKey)return;var keyCode=event.keyCode,isUndo=keyCode===Z_KEY&&!event.shiftKey,isRedo=keyCode===Z_KEY&&event.shiftKey||keyCode===Y_KEY;isUndo?(that.undo(),event.preventDefault()):isRedo&&(that.redo(),event.preventDefault())}),dom.observe(this.element,"keydown",function(event){var keyCode=event.keyCode;if(keyCode===lastKey)return;lastKey=keyCode,(keyCode===BACKSPACE_KEY||keyCode===DELETE_KEY)&&that.transact()});if(wysihtml5.browser.hasUndoInContextMenu()){var interval,observed,cleanUp=function(){cleanTempElements(doc),clearInterval(interval)};dom.observe(this.element,"contextmenu",function(){cleanUp(),that.composer.selection.executeAndRestoreSimple(function(){that.element.lastChild&&that.composer.selection.setAfter(that.element.lastChild),doc.execCommand("insertHTML",!1,UNDO_HTML),doc.execCommand("insertHTML",!1,REDO_HTML),doc.execCommand("undo",!1,null)}),interval=setInterval(function(){doc.getElementById("_wysihtml5-redo")?(cleanUp(),that.redo()):doc.getElementById("_wysihtml5-undo")||(cleanUp(),that.undo())},400),observed||(observed=!0,dom.observe(document,"mousedown",cleanUp),dom.observe(doc,["mousedown","paste","cut","copy"],cleanUp))})}this.editor.observe("newword:composer",function(){that.transact()}).observe("beforecommand:composer",function(){that.transact()})},transact:function(){var previousHtml=this.history[this.position-1],currentHtml=this.composer.getValue();if(currentHtml==previousHtml)return;var length=this.history.length=this.position;length>MAX_HISTORY_ENTRIES&&(this.history.shift(),this.position--),this.position++,this.history.push(currentHtml)},undo:function(){this.transact();if(this.position<=1)return;this.set(this.history[--this.position-1]),this.editor.fire("undo:composer")},redo:function(){if(this.position>=this.history.length)return;this.set(this.history[++this.position-1]),this.editor.fire("redo:composer")},set:function(html){this.composer.setValue(html),this.editor.focus(!0)}})}(wysihtml5),wysihtml5.views.View=Base.extend({constructor:function(parent,textareaElement,config){this.parent=parent,this.element=textareaElement,this.config=config,this._observeViewChange()},_observeViewChange:function(){var that=this;this.parent.observe("beforeload",function(){that.parent.observe("change_view",function(view){view===that.name?(that.parent.currentView=that,that.show(),setTimeout(function(){that.focus()},0)):that.hide()})})},focus:function(){if(this.element.ownerDocument.querySelector(":focus")===this.element)return;try{this.element.focus()}catch(e){}},hide:function(){this.element.style.display="none"},show:function(){this.element.style.display=""},disable:function(){this.element.setAttribute("disabled","disabled")},enable:function(){this.element.removeAttribute("disabled")}}),function(wysihtml5){var dom=wysihtml5.dom,browser=wysihtml5.browser;wysihtml5.views.Composer=wysihtml5.views.View.extend({name:"composer",CARET_HACK:"<br>",constructor:function(parent,textareaElement,config){this.base(parent,textareaElement,config),this.textarea=this.parent.textarea,this._initSandbox()},clear:function(){this.element.innerHTML=browser.displaysCaretInEmptyContentEditableCorrectly()?"":this.CARET_HACK},getValue:function(parse){var value=this.isEmpty()?"":wysihtml5.quirks.getCorrectInnerHTML(this.element);return parse&&(value=this.parent.parse(value)),value=wysihtml5.lang.string(value).replace(wysihtml5.INVISIBLE_SPACE).by(""),value},setValue:function(html,parse){parse&&(html=this.parent.parse(html)),this.element.innerHTML=html},show:function(){this.iframe.style.display=this._displayStyle||"",this.disable(),this.enable()},hide:function(){this._displayStyle=dom.getStyle("display").from(this.iframe),this._displayStyle==="none"&&(this._displayStyle=null),this.iframe.style.display="none"},disable:function(){this.element.removeAttribute("contentEditable"),this.base()},enable:function(){this.element.setAttribute("contentEditable","true"),this.base()},focus:function(setToEnd){this.base();var lastChild=this.element.lastChild;setToEnd&&lastChild&&(lastChild.nodeName==="BR"?this.selection.setBefore(this.element.lastChild):this.selection.setAfter(this.element.lastChild))},getTextContent:function(){return dom.getTextContent(this.element)},isEmpty:function(){var innerHTML=this.element.innerHTML,elementsWithVisualValue="blockquote, ul, ol, img, embed, object, table, iframe, svg, video, audio, button, input, select, textarea";return innerHTML===""||innerHTML===this.CARET_HACK||this.getTextContent()===""&&!this.element.querySelector(elementsWithVisualValue)},_initSandbox:function(){var that=this;this.sandbox=new dom.Sandbox(function(){that._create()},{stylesheets:this.config.stylesheets}),this.iframe=this.sandbox.getIframe();var hiddenField=document.createElement("input");hiddenField.type="hidden",hiddenField.name="_wysihtml5_mode",hiddenField.value=1;var textareaElement=this.textarea.element;dom.insert(this.iframe).after(textareaElement),dom.insert(hiddenField).after(textareaElement)},_create:function(){var that=this;this.doc=this.sandbox.getDocument(),this.element=this.doc.body,this.textarea=this.parent.textarea,this.element.innerHTML=this.textarea.getValue(!0),this.enable(),this.selection=new wysihtml5.Selection(this.parent),this.commands=new wysihtml5.Commands(this.parent),dom.copyAttributes(["className","spellcheck","title","lang","dir","accessKey"]).from(this.textarea.element).to(this.element),dom.addClass(this.element,this.config.composerClassName),this.config.style&&this.style(),this.observe();var name=this.config.name;name&&(dom.addClass(this.element,name),dom.addClass(this.iframe,name)),this.commands.exec("styleWithCSS",!1),this._initAutoLinking(),this._initObjectResizing(),this._initUndoManager(),(this.textarea.element.hasAttribute("autofocus")||document.querySelector(":focus")==this.textarea.element)&&setTimeout(function(){that.focus()},100),wysihtml5.quirks.insertLineBreakOnReturn(this),browser.clearsContentEditableCorrectly()||wysihtml5.quirks.ensureProperClearing(this),browser.clearsListsInContentEditableCorrectly()||wysihtml5.quirks.ensureProperClearingOfLists(this),this.initSync&&this.config.sync&&this.initSync(),this.textarea.hide(),this.parent.fire("beforeload").fire("load")},_initAutoLinking:function(){var that=this,supportsDisablingOfAutoLinking=browser.canDisableAutoLinking(),supportsAutoLinking=browser.doesAutoLinkingInContentEditable();supportsDisablingOfAutoLinking&&this.commands.exec("autoUrlDetect",!1);if(!this.config.autoLink)return;(!supportsAutoLinking||supportsAutoLinking&&supportsDisablingOfAutoLinking)&&this.parent.observe("newword:composer",function(){that.selection.executeAndRestore(function(startContainer,endContainer){dom.autoLink(endContainer.parentNode),that.parent.fire("change")})});var links=this.sandbox.getDocument().getElementsByTagName("a"),urlRegExp=dom.autoLink.URL_REG_EXP,getTextContent=function(element){var textContent=wysihtml5.lang.string(dom.getTextContent(element)).trim();return textContent.substr(0,4)==="www."&&(textContent="http://"+textContent),textContent};dom.observe(this.element,"keydown",function(event){if(!links.length)return;var selectedNode=that.selection.getSelectedNode(event.target.ownerDocument),link=dom.getParentElement(selectedNode,{nodeName:"A"},4),textContent;if(!link)return;textContent=getTextContent(link),setTimeout(function(){var newTextContent=getTextContent(link);if(newTextContent===textContent)return;newTextContent.match(urlRegExp)&&link.setAttribute("href",newTextContent)},0)})},_initObjectResizing:function(){var properties=["width","height"],propertiesLength=properties.length,element=this.element;this.commands.exec("enableObjectResizing",this.config.allowObjectResizing),this.config.allowObjectResizing?browser.supportsEvent("resizeend")&&dom.observe(element,"resizeend",function(event){var target=event.target||event.srcElement,style=target.style,i=0,property;for(;i<propertiesLength;i++)property=properties[i],style[property]&&(target.setAttribute(property,parseInt(style[property],10)),style[property]="");wysihtml5.quirks.redraw(element)}):browser.supportsEvent("resizestart")&&dom.observe(element,"resizestart",function(event){event.preventDefault()})},_initUndoManager:function(){new wysihtml5.UndoManager(this.parent)}})}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,doc=document,win=window,HOST_TEMPLATE=doc.createElement("div"),TEXT_FORMATTING=["background-color","color","cursor","font-family","font-size","font-style","font-variant","font-weight","line-height","letter-spacing","text-align","text-decoration","text-indent","text-rendering","word-break","word-wrap","word-spacing"],BOX_FORMATTING=[],RESIZE_STYLE=["width","height","top","left","right","bottom"],ADDITIONAL_CSS_RULES=["html             { height: 100%; }","body             { min-height: 100%; padding: 0; margin: 0; margin-top: -1px; padding-top: 1px; }","._wysihtml5-temp { display: none; }",wysihtml5.browser.isGecko?"body.placeholder { color: graytext !important; }":"body.placeholder { color: #a9a9a9 !important; }","body[disabled]   { background-color: #eee !important; color: #999 !important; cursor: default !important; }","img:-moz-broken  { -moz-force-broken-image-icon: 1; height: 24px; width: 24px; }"],focusWithoutScrolling=function(element){if(element.setActive)try{element.setActive()}catch(e){}else{var elementStyle=element.style,originalScrollTop=doc.documentElement.scrollTop||doc.body.scrollTop,originalScrollLeft=doc.documentElement.scrollLeft||doc.body.scrollLeft,originalStyles={position:elementStyle.position,top:elementStyle.top,left:elementStyle.left,WebkitUserSelect:elementStyle.WebkitUserSelect};dom.setStyles({position:"absolute",top:"-99999px",left:"-99999px",WebkitUserSelect:"none"}).on(element),element.focus(),dom.setStyles(originalStyles).on(element),win.scrollTo&&win.scrollTo(originalScrollLeft,originalScrollTop)}};wysihtml5.views.Composer.prototype.style=function(){var that=this,originalActiveElement=doc.querySelector(":focus"),textareaElement=this.textarea.element,hasPlaceholder=textareaElement.hasAttribute("placeholder"),originalPlaceholder=hasPlaceholder&&textareaElement.getAttribute("placeholder");this.focusStylesHost=this.focusStylesHost||HOST_TEMPLATE.cloneNode(!1),this.blurStylesHost=this.blurStylesHost||HOST_TEMPLATE.cloneNode(!1),hasPlaceholder&&textareaElement.removeAttribute("placeholder"),textareaElement===originalActiveElement&&textareaElement.blur(),dom.insertCSS(ADDITIONAL_CSS_RULES).into(this.element.ownerDocument),focusWithoutScrolling(textareaElement);var boxFormattingStyles=wysihtml5.lang.array(BOX_FORMATTING).without(["display"]);return originalActiveElement?originalActiveElement.focus():textareaElement.blur(),hasPlaceholder&&textareaElement.setAttribute("placeholder",originalPlaceholder),wysihtml5.browser.hasCurrentStyleProperty()||dom.observe(win,"resize",function(){var originalDisplayStyle=dom.getStyle("display").from(textareaElement);textareaElement.style.display="",dom.copyStyles(RESIZE_STYLE).from(textareaElement).to(that.iframe).andTo(that.focusStylesHost).andTo(that.blurStylesHost),textareaElement.style.display=originalDisplayStyle}),this}}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,browser=wysihtml5.browser,shortcuts={66:"bold",73:"italic",85:"underline"};wysihtml5.views.Composer.prototype.observe=function(){var that=this,state=this.getValue(),iframe=this.sandbox.getIframe(),element=this.element,focusBlurElement=browser.supportsEventsInIframeCorrectly()?element:this.sandbox.getWindow(),pasteEvents=browser.supportsEvent("drop")?["drop","paste"]:["dragdrop","paste"];dom.observe(iframe,"DOMNodeRemoved",function(){clearInterval(domNodeRemovedInterval),that.parent.fire("destroy:composer")});var domNodeRemovedInterval=setInterval(function(){dom.contains(document.documentElement,iframe)||(clearInterval(domNodeRemovedInterval),that.parent.fire("destroy:composer"))},250);dom.observe(focusBlurElement,"focus",function(){that.parent.fire("focus").fire("focus:composer"),setTimeout(function(){state=that.getValue()},0)}),dom.observe(focusBlurElement,"blur",function(){state!==that.getValue()&&that.parent.fire("change").fire("change:composer"),that.parent.fire("blur").fire("blur:composer")}),wysihtml5.browser.isIos()&&dom.observe(element,"blur",function(){var input=element.ownerDocument.createElement("input"),originalScrollTop=document.documentElement.scrollTop||document.body.scrollTop,originalScrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;try{that.selection.insertNode(input)}catch(e){element.appendChild(input)}input.focus(),input.parentNode.removeChild(input),window.scrollTo(originalScrollLeft,originalScrollTop)}),dom.observe(element,"dragenter",function(){that.parent.fire("unset_placeholder")}),browser.firesOnDropOnlyWhenOnDragOverIsCancelled()&&dom.observe(element,["dragover","dragenter"],function(event){event.preventDefault()}),dom.observe(element,pasteEvents,function(event){var dataTransfer=event.dataTransfer,data;dataTransfer&&browser.supportsDataTransfer()&&(data=dataTransfer.getData("text/html")||dataTransfer.getData("text/plain")),data?(element.focus(),that.commands.exec("insertHTML",data),that.parent.fire("paste").fire("paste:composer"),event.stopPropagation(),event.preventDefault()):setTimeout(function(){that.parent.fire("paste").fire("paste:composer")},0)}),dom.observe(element,"keyup",function(event){var keyCode=event.keyCode;(keyCode===wysihtml5.SPACE_KEY||keyCode===wysihtml5.ENTER_KEY)&&that.parent.fire("newword:composer")}),this.parent.observe("paste:composer",function(){setTimeout(function(){that.parent.fire("newword:composer")},0)}),browser.canSelectImagesInContentEditable()||dom.observe(element,"mousedown",function(event){var target=event.target;target.nodeName==="IMG"&&(that.selection.selectNode(target),event.preventDefault())}),dom.observe(element,"keydown",function(event){var keyCode=event.keyCode,command=shortcuts[keyCode];(event.ctrlKey||event.metaKey)&&command&&(that.commands.exec(command),event.preventDefault())}),dom.observe(element,"keydown",function(event){var target=that.selection.getSelectedNode(!0),keyCode=event.keyCode,parent;target&&target.nodeName==="IMG"&&(keyCode===wysihtml5.BACKSPACE_KEY||keyCode===wysihtml5.DELETE_KEY)&&(parent=target.parentNode,parent.removeChild(target),parent.nodeName==="A"&&!parent.firstChild&&parent.parentNode.removeChild(parent),setTimeout(function(){wysihtml5.quirks.redraw(element)},0),event.preventDefault())});var titlePrefixes={IMG:"Image: ",A:"Link: "};dom.observe(element,"mouseover",function(event){var target=event.target,nodeName=target.nodeName,title;if(nodeName!=="A"&&nodeName!=="IMG")return;title=titlePrefixes[nodeName]+(target.getAttribute("href")||target.getAttribute("src")),target.setAttribute("title",title)})}}(wysihtml5),function(wysihtml5){var INTERVAL=400;wysihtml5.views.Synchronizer=Base.extend({constructor:function(editor,textarea,composer){this.editor=editor,this.textarea=textarea,this.composer=composer,this._observe()},fromComposerToTextarea:function(shouldParseHtml){this.textarea.setValue(wysihtml5.lang.string(this.composer.getValue()).trim(),shouldParseHtml)},fromTextareaToComposer:function(shouldParseHtml){var textareaValue=this.textarea.getValue();textareaValue?this.composer.setValue(textareaValue,shouldParseHtml):(this.composer.clear(),this.editor.fire("set_placeholder"))},sync:function(shouldParseHtml){this.editor.currentView.name==="textarea"?this.fromTextareaToComposer(shouldParseHtml):this.fromComposerToTextarea(shouldParseHtml)},_observe:function(){var interval,that=this,form=this.textarea.element.form,startInterval=function(){interval=setInterval(function(){that.fromComposerToTextarea()},INTERVAL)},stopInterval=function(){clearInterval(interval),interval=null};startInterval(),form&&(wysihtml5.dom.observe(form,"submit",function(){that.sync(!0)}),wysihtml5.dom.observe(form,"reset",function(){setTimeout(function(){that.fromTextareaToComposer()},0)})),this.editor.observe("change_view",function(view){view==="composer"&&!interval?(that.fromTextareaToComposer(!0),startInterval()):view==="textarea"&&(that.fromComposerToTextarea(!0),stopInterval())}),this.editor.observe("destroy:composer",stopInterval)}})}(wysihtml5),wysihtml5.views.Textarea=wysihtml5.views.View.extend({name:"textarea",constructor:function(parent,textareaElement,config){this.base(parent,textareaElement,config),this._observe()},clear:function(){this.element.value=""},getValue:function(parse){var value=this.isEmpty()?"":this.element.value;return parse&&(value=this.parent.parse(value)),value},setValue:function(html,parse){parse&&(html=this.parent.parse(html)),this.element.value=html},isEmpty:function(){return!wysihtml5.lang.string(this.element.value).trim()},_observe:function(){var element=this.element,parent=this.parent,eventMapping={focusin:"focus",focusout:"blur"},events=wysihtml5.browser.supportsEvent("focusin")?["focusin","focusout","change"]:["focus","blur","change"];parent.observe("beforeload",function(){wysihtml5.dom.observe(element,events,function(event){var eventName=eventMapping[event.type]||event.type;parent.fire(eventName).fire(eventName+":textarea")}),wysihtml5.dom.observe(element,["paste","drop"],function(){setTimeout(function(){parent.fire("paste").fire("paste:textarea")},0)})})}}),function(wysihtml5){var dom=wysihtml5.dom,CLASS_NAME_OPENED="wysihtml5-command-dialog-opened",SELECTOR_FORM_ELEMENTS="input, select, textarea",SELECTOR_FIELDS="[data-wysihtml5-dialog-field]",ATTRIBUTE_FIELDS="data-wysihtml5-dialog-field";wysihtml5.toolbar.Dialog=wysihtml5.lang.Dispatcher.extend({constructor:function(link,container){this.link=link,this.container=container},_observe:function(){if(this._observed)return;var that=this,callbackWrapper=function(event){var attributes=that._serialize();attributes==that.elementToChange?that.fire("edit",attributes):that.fire("save",attributes),that.hide(),event.preventDefault(),event.stopPropagation()};dom.observe(that.link,"click",function(event){dom.hasClass(that.link,CLASS_NAME_OPENED)&&setTimeout(function(){that.hide()},0)}),dom.observe(this.container,"keydown",function(event){var keyCode=event.keyCode;keyCode===wysihtml5.ENTER_KEY&&callbackWrapper(event),keyCode===wysihtml5.ESCAPE_KEY&&that.hide()}),dom.delegate(this.container,"[data-wysihtml5-dialog-action=save]","click",callbackWrapper),dom.delegate(this.container,"[data-wysihtml5-dialog-action=cancel]","click",function(event){that.fire("cancel"),that.hide(),event.preventDefault(),event.stopPropagation()});var formElements=this.container.querySelectorAll(SELECTOR_FORM_ELEMENTS),i=0,length=formElements.length,_clearInterval=function(){clearInterval(that.interval)};for(;i<length;i++)dom.observe(formElements[i],"change",_clearInterval);this._observed=!0},_serialize:function(){var data=this.elementToChange||{},fields=this.container.querySelectorAll(SELECTOR_FIELDS),length=fields.length,i=0;for(;i<length;i++)data[fields[i].getAttribute(ATTRIBUTE_FIELDS)]=fields[i].value;return data},_interpolate:function(avoidHiddenFields){var field,fieldName,newValue,focusedElement=document.querySelector(":focus"),fields=this.container.querySelectorAll(SELECTOR_FIELDS),length=fields.length,i=0;for(;i<length;i++){field=fields[i];if(field===focusedElement)continue;if(avoidHiddenFields&&field.type==="hidden")continue;fieldName=field.getAttribute(ATTRIBUTE_FIELDS),newValue=this.elementToChange?this.elementToChange[fieldName]||"":field.defaultValue,field.value=newValue}},show:function(elementToChange){var that=this,firstField=this.container.querySelector(SELECTOR_FORM_ELEMENTS);this.elementToChange=elementToChange,this._observe(),this._interpolate(),elementToChange&&(this.interval=setInterval(function(){that._interpolate(!0)},500)),dom.addClass(this.link,CLASS_NAME_OPENED),this.container.style.display="",this.fire("show");if(firstField&&!elementToChange)try{firstField.focus()}catch(e){}},hide:function(){clearInterval(this.interval),this.elementToChange=null,dom.removeClass(this.link,CLASS_NAME_OPENED),this.container.style.display="none",this.fire("hide")}})}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,linkStyles={position:"relative"},wrapperStyles={left:0,margin:0,opacity:0,overflow:"hidden",padding:0,position:"absolute",top:0,zIndex:1},inputStyles={cursor:"inherit",fontSize:"50px",height:"50px",marginTop:"-25px",outline:0,padding:0,position:"absolute",right:"-4px",top:"50%"},inputAttributes={"x-webkit-speech":"",speech:""};wysihtml5.toolbar.Speech=function(parent,link){var input=document.createElement("input");if(!wysihtml5.browser.supportsSpeechApiOn(input)){link.style.display="none";return}var wrapper=document.createElement("div");wysihtml5.lang.object(wrapperStyles).merge({width:link.offsetWidth+"px",height:link.offsetHeight+"px"}),dom.insert(input).into(wrapper),dom.insert(wrapper).into(link),dom.setStyles(inputStyles).on(input),dom.setAttributes(inputAttributes).on(input),dom.setStyles(wrapperStyles).on(wrapper),dom.setStyles(linkStyles).on(link);var eventName="onwebkitspeechchange"in input?"webkitspeechchange":"speechchange";dom.observe(input,eventName,function(){parent.execCommand("insertText",input.value),input.value=""}),dom.observe(input,"click",function(event){dom.hasClass(link,"wysihtml5-command-disabled")&&event.preventDefault(),event.stopPropagation()})}}(wysihtml5),function(wysihtml5){var CLASS_NAME_COMMAND_DISABLED="wysihtml5-command-disabled",CLASS_NAME_COMMANDS_DISABLED="wysihtml5-commands-disabled",CLASS_NAME_COMMAND_ACTIVE="wysihtml5-command-active",dom=wysihtml5.dom;wysihtml5.toolbar.Toolbar=Base.extend({constructor:function(editor,container){this.editor=editor,this.container=typeof container=="string"?document.getElementById(container):container,this.composer=editor.composer,this._getLinks("command"),this._getLinks("action"),this._observe(),this.show();var speechInputLinks=this.container.querySelectorAll("[data-wysihtml5-command=insertSpeech]"),length=speechInputLinks.length,i=0;for(;i<length;i++)new wysihtml5.toolbar.Speech(this,speechInputLinks[i])},_getLinks:function(type){var links=this[type+"Links"]=wysihtml5.lang.array(this.container.querySelectorAll("a[data-wysihtml5-"+type+"]")).get(),length=links.length,i=0,mapping=this[type+"Mapping"]={},link,name,value,dialog;for(;i<length;i++)link=links[i],name=link.getAttribute("data-wysihtml5-"+type),value=link.getAttribute("data-wysihtml5-"+type+"-value"),dialog=this._getDialog(link,name),mapping[name+":"+value]={link:link,name:name,value:value,dialog:dialog,state:!1}},_getDialog:function(link,command){var that=this,dialogElement=this.container.querySelector("[data-wysihtml5-dialog='"+command+"']"),dialog,caretBookmark;return dialogElement&&(dialog=new wysihtml5.toolbar.Dialog(link,dialogElement),dialog.observe("show",function(){caretBookmark=that.composer.selection.getBookmark(),that.editor.fire("show:dialog",{command:command,dialogContainer:dialogElement,commandLink:link})}),dialog.observe("save",function(attributes){caretBookmark&&that.composer.selection.setBookmark(caretBookmark),that._execCommand(command,attributes),that.editor.fire("save:dialog",{command:command,dialogContainer:dialogElement,commandLink:link})}),dialog.observe("cancel",function(){that.editor.focus(!1),that.editor.fire("cancel:dialog",{command:command,dialogContainer:dialogElement,commandLink:link})})),dialog},execCommand:function(command,commandValue){if(this.commandsDisabled)return;var commandObj=this.commandMapping[command+":"+commandValue];if(!(commandObj&&commandObj.dialog&&!commandObj.state))return this._execCommand(command,commandValue);commandObj.dialog.show()},_execCommand:function(command,commandValue){this.editor.focus(!1);var retval=this.composer.commands.exec(command,commandValue);return this._updateLinkStates(),retval},execAction:function(action){var editor=this.editor;switch(action){case"change_view":editor.currentView===editor.textarea?editor.fire("change_view","composer"):editor.fire("change_view","textarea")}},_observe:function(){var that=this,editor=this.editor,container=this.container,links=this.commandLinks.concat(this.actionLinks),length=links.length,i=0;dom.delegate(container,"[data-wysihtml5-command]","mousedown",function(event){event.preventDefault()}),dom.delegate(container,"[data-wysihtml5-command]","click",function(event){var link=this,command=link.getAttribute("data-wysihtml5-command"),commandValue=link.getAttribute("data-wysihtml5-command-value"),retval=that.execCommand(command,commandValue);retval||event.stopPropagation(),event.preventDefault()}),dom.delegate(container,"[data-wysihtml5-action]","click",function(event){var action=this.getAttribute("data-wysihtml5-action");that.execAction(action),event.preventDefault()}),editor.observe("focus:composer",function(){that.bookmark=null,clearInterval(that.interval),that.interval=setInterval(function(){that._updateLinkStates()},500)}),editor.observe("blur:composer",function(){clearInterval(that.interval)}),editor.observe("destroy:composer",function(){clearInterval(that.interval)}),editor.observe("change_view",function(currentView){setTimeout(function(){that.commandsDisabled=currentView!=="composer",that._updateLinkStates(),that.commandsDisabled?dom.addClass(container,CLASS_NAME_COMMANDS_DISABLED):dom.removeClass(container,CLASS_NAME_COMMANDS_DISABLED)},0)})},_updateLinkStates:function(){var element=this.composer.element,commandMapping=this.commandMapping,i,state,command;for(i in commandMapping){command=commandMapping[i],this.commandsDisabled?(state=!1,dom.removeClass(command.link,CLASS_NAME_COMMAND_ACTIVE),command.dialog&&command.dialog.hide()):(state=this.composer.commands.state(command.name,command.value),wysihtml5.lang.object(state).isArray()&&(state=state.length===1?state[0]:!0),dom.removeClass(command.link,CLASS_NAME_COMMAND_DISABLED));if(command.state===state)continue;command.state=state,state?(dom.addClass(command.link,CLASS_NAME_COMMAND_ACTIVE),command.dialog&&(typeof state=="object"?command.dialog.show(state):command.dialog.hide())):(dom.removeClass(command.link,CLASS_NAME_COMMAND_ACTIVE),command.dialog&&command.dialog.hide())}},show:function(){this.container.style.display=""},hide:function(){this.container.style.display="none"}})}(wysihtml5),function(wysihtml5){var undef,defaultConfig={name:undef,style:!0,toolbar:undef,autoLink:!0,parserRules:{tags:{br:{},span:{},div:{},p:{}},classes:{}},parser:wysihtml5.dom.parse,composerClassName:"wysihtml5-editor",bodyClassName:"wysihtml5-supported",stylesheets:[],placeholderText:undef,allowObjectResizing:!0,supportTouchDevices:!0};wysihtml5.Editor=wysihtml5.lang.Dispatcher.extend({constructor:function(textareaElement,config){this.textareaElement=typeof textareaElement=="string"?document.getElementById(textareaElement):textareaElement,this.config=wysihtml5.lang.object({}).merge(defaultConfig).merge(config).get(),this.textarea=new wysihtml5.views.Textarea(this,this.textareaElement,this.config),this.currentView=this.textarea,this._isCompatible=wysihtml5.browser.supported();if(!this._isCompatible||!this.config.supportTouchDevices&&wysihtml5.browser.isTouchDevice()){var that=this;setTimeout(function(){that.fire("beforeload").fire("load")},0);return}wysihtml5.dom.addClass(document.body,this.config.bodyClassName),this.composer=new wysihtml5.views.Composer(this,this.textareaElement,this.config),this.currentView=this.composer,typeof this.config.parser=="function"&&this._initParser(),this.observe("beforeload",function(){this.synchronizer=new wysihtml5.views.Synchronizer(this,this.textarea,this.composer),this.config.toolbar&&(this.toolbar=new wysihtml5.toolbar.Toolbar(this,this.config.toolbar))})},isCompatible:function(){return this._isCompatible},clear:function(){return this.currentView.clear(),this},getValue:function(parse){return this.currentView.getValue(parse)},setValue:function(html,parse){return html?(this.currentView.setValue(html,parse),this):this.clear()},focus:function(setToEnd){return this.currentView.focus(setToEnd),this},disable:function(){return this.currentView.disable(),this},enable:function(){return this.currentView.enable(),this},isEmpty:function(){return this.currentView.isEmpty()},parse:function(htmlOrElement){var returnValue=this.config.parser(htmlOrElement,this.config.parserRules,this.composer.sandbox.getDocument(),!0);return typeof htmlOrElement=="object"&&wysihtml5.quirks.redraw(htmlOrElement),returnValue},_initParser:function(){this.observe("paste:composer",function(){var keepScrollPosition=!0,that=this;that.composer.selection.executeAndRestore(function(){wysihtml5.quirks.cleanPastedHTML(that.composer.element),that.parse(that.composer.element)},keepScrollPosition)}),this.observe("paste:textarea",function(){var value=this.textarea.getValue(),newValue;newValue=this.parse(value),this.textarea.setValue(newValue)})}})}(wysihtml5)